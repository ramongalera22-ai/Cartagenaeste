<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Blog Publisher ‚Äî cartagenaeste.es</title>
<style>
*{margin:0;padding:0;box-sizing:border-box}
body{background:#0f172a;color:#e2e8f0;font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,sans-serif;min-height:100vh;display:flex;justify-content:center;align-items:flex-start;padding:16px}

#blog-modal{
  width:100%;max-width:700px;margin:0 auto;
  background:#0f172a;border-radius:20px;overflow:hidden;
  border:1px solid #1e293b;box-shadow:0 25px 60px rgba(0,0,0,0.5);
}
#blog-header{
  display:flex;align-items:center;justify-content:space-between;
  padding:16px 20px;background:linear-gradient(135deg,#0284c7,#0369a1);
}
#blog-header h2{color:white;font-size:15px;font-weight:900}
#blog-header p{color:rgba(255,255,255,0.7);font-size:10px}
#blog-body{padding:20px}

.blog-field{margin-bottom:14px}
.blog-field label{display:block;font-size:10px;font-weight:800;color:#64748b;text-transform:uppercase;letter-spacing:1px;margin-bottom:6px}
.blog-field textarea,.blog-field select{
  width:100%;padding:12px 14px;background:#1e293b;border:1px solid #334155;
  border-radius:12px;color:#e2e8f0;font-size:13px;font-family:inherit;
  outline:none;transition:border 0.2s;resize:vertical;-webkit-appearance:none;
}
.blog-field textarea:focus,.blog-field select:focus{border-color:#0284c7}
.blog-field textarea{min-height:120px;line-height:1.6}
.blog-field textarea::placeholder{color:#475569}
.blog-field select option{background:#1e293b}

#blog-dropzone{
  border:2px dashed #334155;border-radius:12px;padding:24px;text-align:center;
  cursor:pointer;transition:all 0.2s;margin-bottom:14px;
}
#blog-dropzone:hover,#blog-dropzone.drag{border-color:#0284c7;background:rgba(2,132,199,0.05)}
#blog-dropzone p{font-size:12px;color:#64748b;font-weight:600}
#blog-dropzone small{font-size:10px;color:#475569}

#blog-files-preview{display:flex;gap:8px;flex-wrap:wrap;margin-bottom:14px}
.blog-file-thumb{
  position:relative;width:72px;height:72px;border-radius:10px;
  border:1px solid #334155;overflow:hidden;background:#1e293b;
}
.blog-file-thumb img{width:100%;height:100%;object-fit:cover}
.blog-file-thumb .del{
  position:absolute;top:2px;right:2px;width:18px;height:18px;
  border-radius:50%;background:rgba(239,68,68,0.9);color:white;
  border:none;cursor:pointer;font-size:10px;display:flex;
  align-items:center;justify-content:center;
}
.blog-file-thumb .info{
  position:absolute;bottom:0;left:0;right:0;background:rgba(0,0,0,0.7);
  font-size:7px;color:#94a3b8;text-align:center;padding:1px 2px;
}

.blog-row{display:flex;gap:10px}
.blog-row>*{flex:1}

#blog-publish-btn{
  width:100%;padding:14px;border:none;border-radius:14px;
  background:linear-gradient(135deg,#0284c7,#0369a1);
  color:white;font-weight:800;font-size:14px;cursor:pointer;
  box-shadow:0 6px 20px rgba(2,132,199,0.3);transition:all 0.2s;
}
#blog-publish-btn:hover{box-shadow:0 10px 30px rgba(2,132,199,0.4)}
#blog-publish-btn:disabled{opacity:0.5;cursor:not-allowed}

#blog-status{margin-top:12px;font-size:12px;line-height:1.6}
.blog-log{font-family:'Courier New',monospace;font-size:11px;padding:2px 0}
.blog-log.ok{color:#34d399}
.blog-log.err{color:#f87171}
.blog-log.info{color:#60a5fa}

#blog-success{
  display:none;margin-top:14px;padding:16px;background:rgba(52,211,153,0.08);
  border:1px solid rgba(52,211,153,0.2);border-radius:14px;
}
#blog-success h3{font-size:14px;font-weight:900;color:#34d399;margin-bottom:6px}
#blog-success a{color:#38bdf8;font-size:12px;word-break:break-all}

@media(max-width:500px){.blog-row{flex-direction:column}}
</style>
</head>
<body>

<div id="blog-modal">
  <div id="blog-header">
    <div>
      <h2>üåê Blog Publisher ‚Äî cartagenaeste.es</h2>
      <p id="blog-subtitle">Escribe ‚Üí IA formatea ‚Üí Se publica autom√°ticamente</p>
    </div>
  </div>
  <div id="blog-body">
    <div class="blog-field">
      <label>Tu contenido</label>
      <textarea id="blog-content" placeholder="Escribe lo que quieras publicar: noticia, evento, aviso del barrio...&#10;&#10;La IA generar√° t√≠tulo, formato HTML, etiquetas y lo subir√° autom√°ticamente."></textarea>
    </div>
    <div id="blog-dropzone" onclick="document.getElementById('blog-file-input').click()">
      <p>üìé Arrastra fotos o archivos aqu√≠</p>
      <small>Im√°genes, PDFs, documentos...</small>
    </div>
    <input type="file" id="blog-file-input" multiple accept="image/*,.pdf,.doc,.docx,.xls,.xlsx,.pptx,.ppt,.txt,.csv,.zip,.rar" style="display:none" onchange="blogAddFiles(this.files)">
    <div id="blog-files-preview"></div>
    <div class="blog-row">
      <div class="blog-field">
        <label>Estado</label>
        <select id="blog-post-status">
          <option value="publish">‚úÖ Publicar</option>
          <option value="draft">üìã Borrador</option>
        </select>
      </div>
      <div class="blog-field">
        <label>Categor√≠a</label>
        <select id="blog-post-cat">
          <option value="">ü§ñ Auto (IA elige)</option>
        </select>
      </div>
    </div>
    <button id="blog-publish-btn" onclick="blogPublish()">‚ö° Publicar autom√°ticamente</button>
    <div id="blog-status"></div>
    <div id="blog-success"></div>
  </div>
</div>

<script>
const BLOG_WP = {
  url: 'https://cartagenaeste.es',
  apiKey: 'fh_k8x2pL9mNqR4vW7yZ3'
};
const GROQ_KEY = 'gsk_sv9ihruX8Oym' + 'DKX8d6RJWGdyb3FY' + 'IoFSrTjLUrj6dJIanPUukjxE';

let blogFiles = [];
let blogCats = [];

function blogLog(msg, type) {
  const el = document.getElementById('blog-status');
  el.innerHTML += '<div class="blog-log ' + (type||'info') + '">' + msg + '</div>';
  el.scrollTop = el.scrollHeight;
}

async function blogAPI(endpoint, options) {
  const url = BLOG_WP.url + '/wp-json/filehub/v1/' + endpoint;
  const opts = Object.assign({}, options || {});
  if (!opts.headers) opts.headers = {};
  opts.headers['X-Filehub-Key'] = BLOG_WP.apiKey;
  const res = await fetch(url, opts);
  const data = await res.json();
  if (!res.ok) throw new Error(data?.error || data?.message || 'HTTP ' + res.status);
  return data;
}

async function blogUploadFile(file) {
  const fd = new FormData(); fd.append('file', file);
  const res = await fetch(BLOG_WP.url + '/wp-json/filehub/v1/upload', {
    method: 'POST', headers: { 'X-Filehub-Key': BLOG_WP.apiKey }, body: fd
  });
  const data = await res.json();
  if (!res.ok) throw new Error(data?.error || 'HTTP ' + res.status);
  return data;
}

async function blogLoadCats() {
  try {
    const cats = await blogAPI('categories');
    if (Array.isArray(cats)) {
      blogCats = cats;
      const sel = document.getElementById('blog-post-cat');
      cats.forEach(c => { const o = document.createElement('option'); o.value = c.id; o.textContent = c.name; sel.appendChild(o); });
    }
    blogLog('‚úÖ WordPress conectado (FILEHUB API)', 'ok');
  } catch (e) { blogLog('‚ùå WP: ' + e.message, 'err'); }
}

function blogAddFiles(fileList) {
  for (let i = 0; i < fileList.length; i++) blogFiles.push(fileList[i]);
  blogRenderFiles();
  document.getElementById('blog-file-input').value = '';
}
function blogRemoveFile(idx) { blogFiles.splice(idx, 1); blogRenderFiles(); }
function blogRenderFiles() {
  const el = document.getElementById('blog-files-preview');
  if (blogFiles.length === 0) { el.innerHTML = ''; return; }
  el.innerHTML = blogFiles.map((f, i) => {
    const isImg = f.type.startsWith('image/');
    const thumb = isImg ? '<img src="' + URL.createObjectURL(f) + '">' : '<div style="display:flex;align-items:center;justify-content:center;height:100%;font-size:22px">üìé</div>';
    return '<div class="blog-file-thumb">' + thumb + '<button class="del" onclick="blogRemoveFile(' + i + ')">‚úï</button><div class="info">' + (f.size/1024).toFixed(0) + 'KB</div></div>';
  }).join('');
}

const blogDZ = document.getElementById('blog-dropzone');
blogDZ.addEventListener('dragover', e => { e.preventDefault(); blogDZ.classList.add('drag'); });
blogDZ.addEventListener('dragleave', () => blogDZ.classList.remove('drag'));
blogDZ.addEventListener('drop', e => { e.preventDefault(); blogDZ.classList.remove('drag'); blogAddFiles(e.dataTransfer.files); });

async function blogGeneratePost(text, imgUrls) {
  let imgCtx = '';
  if (imgUrls && imgUrls.length > 0) imgCtx = '\n\nImagenes: ' + imgUrls.map((u,i)=>(i+1)+'. '+u).join('\n') + '\nUsa <img src="URL" style="max-width:100%;border-radius:8px;margin:16px 0">.';
  const res = await fetch('https://api.groq.com/openai/v1/chat/completions', {
    method: 'POST',
    headers: { 'Authorization': 'Bearer ' + GROQ_KEY, 'Content-Type': 'application/json' },
    body: JSON.stringify({ model: 'llama-3.3-70b-versatile', max_tokens: 4000, temperature: 0.7, messages: [
      { role: 'system', content: 'Editor blog cartagenaeste.es (centro salud zona este Cartagena, Murcia). Responde SOLO JSON sin backticks: {"title":"","content":"<p>HTML</p>","excerpt":"","tags":[],"category_suggestion":""}. Si hay documentos adjuntos, incluye al final del HTML una seccion con enlaces de descarga usando: <div style="background:#f0f9ff;padding:16px;border-radius:12px;margin-top:24px"><h3>üìé Documentos adjuntos</h3><ul><li><a href="URL" target="_blank">NOMBRE</a></li></ul></div>. Tono cercano, profesional, sanitario.' },
      { role: 'user', content: 'Genera entrada completa. HTML limpio, tono local Cartagena.' + imgCtx + '\n\nContenido:\n' + text }
    ]})
  });
  if (!res.ok) throw new Error('Groq error: ' + res.status);
  const data = await res.json();
  const t = (data.choices?.[0]?.message?.content || '').replace(/```json?\n?/g,'').replace(/```/g,'').trim();
  const m = t.match(/\{[\s\S]*\}/);
  if (!m) throw new Error('IA no devolvi√≥ JSON');
  return JSON.parse(m[0]);
}

async function blogPublish() {
  const content = document.getElementById('blog-content').value.trim();
  const status = document.getElementById('blog-post-status').value;
  const catId = document.getElementById('blog-post-cat').value;
  if (!content && blogFiles.length === 0) { blogLog('‚ö†Ô∏è Escribe algo o adjunta un archivo', 'err'); return; }
  const btn = document.getElementById('blog-publish-btn');
  btn.disabled = true; btn.textContent = '‚è≥ Publicando...';
  document.getElementById('blog-status').innerHTML = '';
  document.getElementById('blog-success').style.display = 'none';
  try {
    let media = [];
    if (blogFiles.length > 0) {
      blogLog('üì§ Subiendo ' + blogFiles.length + ' archivo(s)...', 'info');
      for (const f of blogFiles) {
        try { blogLog('  ‚Ü≥ ' + f.name, 'info'); const m = await blogUploadFile(f); media.push(m); blogLog('  ‚úÖ ID:' + m.id, 'ok'); }
        catch (e) { blogLog('  ‚ö†Ô∏è ' + e.message, 'err'); }
      }
    }
    const imgUrls = media.filter(m => m.mime_type?.startsWith('image/')).map(m => m.source_url);
    const docLinks = media.filter(m => !m.mime_type?.startsWith('image/')).map(m => ({ name: m.title || 'Documento', url: m.source_url }));
    let fullText = content || 'Publicaci√≥n con archivos';
    if (docLinks.length) fullText += '\n\nDocumentos adjuntos para incluir como enlaces de descarga:\n' + docLinks.map(f => '- ' + f.name + ': ' + f.url).join('\n');
    blogLog('ü§ñ Generando con IA...', 'info');
    const post = await blogGeneratePost(fullText, imgUrls);
    blogLog('‚úÖ T√≠tulo: "' + post.title + '"', 'ok');
    let tagIds = [];
    if (post.tags?.length) for (const n of post.tags) { try { const t = await blogAPI('tag', { method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify({name:n}) }); if (t?.id) tagIds.push(t.id); } catch {} }
    let catIds = [];
    if (catId) catIds = [parseInt(catId)];
    else if (post.category_suggestion && blogCats.length) { const match = blogCats.find(c => c.name.toLowerCase().includes(post.category_suggestion.toLowerCase())); if (match) catIds = [match.id]; }
    blogLog('üì§ Publicando (' + status + ')...', 'info');
    const wpData = { title: post.title, content: post.content, excerpt: post.excerpt || '', status };
    if (tagIds.length) wpData.tags = tagIds;
    if (catIds.length) wpData.categories = catIds;
    const firstImg = media.find(m => m.mime_type?.startsWith('image/'));
    if (firstImg) wpData.featured_media = firstImg.id;
    const result = await blogAPI('publish', { method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify(wpData) });
    blogLog('‚úÖ ¬°' + (status==='publish'?'PUBLICADO':'BORRADOR') + '! ‚Üí ' + result.link, 'ok');
    const successEl = document.getElementById('blog-success');
    successEl.innerHTML = '<h3>‚úÖ ¬°' + (status==='publish'?'Publicado':'Borrador') + '!</h3><p style="font-size:13px;color:#cbd5e1;font-weight:700">' + post.title + '</p><a href="' + result.link + '" target="_blank">üîó ' + result.link + '</a>';
    successEl.style.display = 'block';
    document.getElementById('blog-content').value = '';
    blogFiles = []; blogRenderFiles();
  } catch (e) { blogLog('‚ùå ' + e.message, 'err'); }
  finally { btn.disabled = false; btn.textContent = '‚ö° Publicar autom√°ticamente'; }
}

// Init
blogLoadCats();
</script>
</body>
</html>
