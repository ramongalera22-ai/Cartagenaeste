<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Blog Publisher ‚Äî cartagenaeste.es</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link href="https://fonts.googleapis.com/css2?family=Outfit:wght@400;500;600;700;800;900&display=swap" rel="stylesheet">
<style>
*{margin:0;padding:0;box-sizing:border-box}
:root{
  --bg:#0f1729;--card:#1a2342;--card2:#1e2a4a;--border:#263354;
  --text:#e8ecf4;--sub:#8899b8;--accent:#38bdf8;--accent2:#0ea5e9;
  --green:#34d399;--red:#f87171;--yellow:#fbbf24;
}
html,body{height:100%;font-family:'Outfit',sans-serif;background:var(--bg);color:var(--text);-webkit-font-smoothing:antialiased}
body::before{
  content:'';position:fixed;inset:0;z-index:0;pointer-events:none;
  background:
    radial-gradient(ellipse 500px 400px at 15% 10%,rgba(56,189,248,0.06),transparent),
    radial-gradient(ellipse 400px 400px at 85% 90%,rgba(52,211,153,0.04),transparent);
}

.page{min-height:100%;display:flex;flex-direction:column;align-items:center;padding:20px 16px 40px;position:relative;z-index:1}

/* Header */
.header{
  display:flex;align-items:center;gap:12px;width:100%;max-width:520px;
  padding:16px 18px;background:linear-gradient(135deg,var(--accent2),var(--accent));
  border-radius:16px 16px 0 0;
}
.header-icon{font-size:24px}
.header h1{font-size:16px;font-weight:800;color:#0f1729;flex:1}
.header p{font-size:10px;color:rgba(15,23,41,0.7);font-weight:600}

/* Main card */
.main{
  width:100%;max-width:520px;background:var(--card);
  border:1px solid var(--border);border-top:none;
  border-radius:0 0 16px 16px;padding:20px 18px;
}

/* Field */
.field{margin-bottom:18px}
.field-label{
  font-size:11px;font-weight:800;color:var(--sub);
  text-transform:uppercase;letter-spacing:1.5px;margin-bottom:8px;display:block;
}

textarea{
  width:100%;padding:14px 16px;background:var(--bg);border:2px solid var(--border);
  border-radius:12px;font-family:inherit;font-size:14px;color:var(--text);
  outline:none;resize:vertical;min-height:120px;line-height:1.6;transition:border .2s;
}
textarea:focus{border-color:var(--accent)}
textarea::placeholder{color:#4a5a7a}

/* Dropzone */
.dropzone{
  border:2px dashed var(--border);border-radius:12px;padding:24px 16px;
  text-align:center;cursor:pointer;transition:all .2s;background:transparent;
}
.dropzone:hover,.dropzone.drag{border-color:var(--accent);background:rgba(56,189,248,0.05)}
.dropzone .dz-icon{font-size:24px;margin-bottom:4px}
.dropzone .dz-title{font-size:13px;font-weight:700;color:var(--text)}
.dropzone .dz-sub{font-size:11px;color:var(--sub);margin-top:2px}
.dropzone input{display:none}

/* File list */
.files{margin-top:10px}
.file-item{
  display:flex;align-items:center;gap:10px;padding:10px 12px;
  background:var(--bg);border:1px solid var(--border);border-radius:10px;
  margin-bottom:6px;animation:slideIn .2s ease;
}
@keyframes slideIn{from{opacity:0;transform:translateY(-6px)}}
.file-item .fi{font-size:18px;flex-shrink:0}
.file-item .fname{flex:1;font-size:12px;font-weight:600;overflow:hidden;text-overflow:ellipsis;white-space:nowrap}
.file-item .fsize{font-size:10px;color:var(--sub)}
.file-item .fremove{
  width:24px;height:24px;border-radius:6px;border:none;
  background:rgba(248,113,113,0.15);color:var(--red);cursor:pointer;
  display:flex;align-items:center;justify-content:center;font-size:12px;
  transition:all .15s;flex-shrink:0;
}
.file-item .fremove:hover{background:var(--red);color:white}

/* Options row */
.opts{display:flex;gap:10px;margin-bottom:18px}
.opts>div{flex:1}
.opts select{
  width:100%;padding:12px 14px;background:var(--bg);border:2px solid var(--border);
  border-radius:10px;font-family:inherit;font-size:13px;font-weight:600;
  color:var(--text);outline:none;cursor:pointer;-webkit-appearance:none;
  background-image:url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='16' height='16' viewBox='0 0 24 24' fill='none' stroke='%238899b8' stroke-width='2'%3E%3Cpath d='M6 9l6 6 6-6'/%3E%3C/svg%3E");
  background-repeat:no-repeat;background-position:right 10px center;padding-right:36px;
}
.opts select:focus{border-color:var(--accent)}

/* Publish button */
.pub-btn{
  width:100%;padding:16px;border:none;border-radius:12px;
  background:linear-gradient(135deg,var(--accent2),var(--accent));
  color:#0f1729;font-family:inherit;font-size:15px;font-weight:900;
  cursor:pointer;transition:all .2s;display:flex;align-items:center;
  justify-content:center;gap:8px;
  box-shadow:0 4px 20px rgba(56,189,248,0.25);
}
.pub-btn:hover{transform:translateY(-1px);box-shadow:0 6px 28px rgba(56,189,248,0.35)}
.pub-btn:active{transform:translateY(0)}
.pub-btn:disabled{opacity:.5;cursor:not-allowed;transform:none}
.pub-btn .spinner{
  width:18px;height:18px;border:2.5px solid rgba(15,23,41,0.2);
  border-top-color:#0f1729;border-radius:50%;animation:spin .7s linear infinite;
}
@keyframes spin{to{transform:rotate(360deg)}}

/* Log */
.log{margin-top:16px;font-size:12px;font-family:'Outfit',monospace}
.log-line{display:flex;align-items:flex-start;gap:8px;padding:4px 0;animation:fadeIn .25s}
@keyframes fadeIn{from{opacity:0}}
.log-line .li{flex-shrink:0;font-size:13px}
.log-line.info{color:var(--sub)}
.log-line.ok{color:var(--green)}
.log-line.err{color:var(--red)}
.log-line.title{color:var(--accent);font-weight:700}

/* Success */
.success{
  margin-top:16px;padding:16px 18px;
  background:rgba(52,211,153,0.1);border:1px solid rgba(52,211,153,0.25);
  border-radius:14px;animation:popIn .3s ease;
}
@keyframes popIn{from{opacity:0;transform:scale(.95)}}
.success h3{font-size:14px;font-weight:900;color:var(--green);margin-bottom:4px;display:flex;align-items:center;gap:6px}
.success .stitle{font-size:13px;font-weight:800;color:var(--text);margin-bottom:6px}
.success a{color:var(--accent);font-size:12px;font-weight:600;word-break:break-all}
.success .again{
  display:inline-flex;align-items:center;gap:6px;margin-top:12px;
  padding:10px 18px;background:var(--accent);color:#0f1729;border:none;
  border-radius:10px;font-family:inherit;font-size:12px;font-weight:800;
  cursor:pointer;transition:all .15s;
}
.success .again:hover{background:#7dd3fc}

.footer{text-align:center;padding:24px 16px 8px;font-size:10px;color:var(--sub)}
.footer a{color:var(--accent);text-decoration:none;font-weight:700}

@media(max-width:480px){.opts{flex-direction:column;gap:10px}}
</style>
</head>
<body>
<div class="page">

  <div class="header">
    <span class="header-icon">üåê</span>
    <div>
      <h1>Blog Publisher ‚Äî cartagenaeste.es</h1>
      <p>Escribe ‚Üí IA formatea ‚Üí Se publica autom√°ticamente</p>
    </div>
  </div>

  <div class="main">
    <div class="field">
      <span class="field-label">Tu contenido</span>
      <textarea id="content" placeholder="Escribe lo que quieras publicar: noticia, sesi√≥n cl√≠nica, evento, aviso del barrio...&#10;&#10;La IA generar√° t√≠tulo, formato HTML, etiquetas y lo subir√° autom√°ticamente."></textarea>
    </div>

    <div class="field">
      <div class="dropzone" id="dropzone">
        <div class="dz-icon">üìé</div>
        <div class="dz-title">Arrastra fotos o archivos aqu√≠</div>
        <div class="dz-sub">Im√°genes, PDFs, Word, Excel, PowerPoint...</div>
        <input type="file" id="fileInput" multiple accept="image/*,.pdf,.doc,.docx,.xls,.xlsx,.pptx,.ppt,.txt,.csv,.zip,.rar">
      </div>
      <div class="files" id="filesList"></div>
    </div>

    <div class="opts">
      <div>
        <span class="field-label">Estado</span>
        <select id="status">
          <option value="publish">‚úèÔ∏è Publicar</option>
          <option value="draft">üìã Borrador</option>
        </select>
      </div>
      <div>
        <span class="field-label">Categor√≠a</span>
        <select id="category">
          <option value="">ü§ñ Autom√°tica</option>
        </select>
      </div>
    </div>

    <button class="pub-btn" id="pubBtn" onclick="doPublish()">‚ö° Publicar autom√°ticamente</button>

    <div class="log" id="log"></div>
    <div id="successBox" style="display:none"></div>
  </div>

  <div class="footer">
    Publicador del blog de <a href="https://cartagenaeste.es" target="_blank">cartagenaeste.es</a> ¬∑ Centro de Salud Cartagena Este
  </div>
</div>

<script>
const WP={url:'https://cartagenaeste.es',key:'fh_k8x2pL9mNqR4vW7yZ3'};
const GROQ='gsk_sv9ihruX8Oym'+'DKX8d6RJWGdyb3FY'+'IoFSrTjLUrj6dJIanPUukjxE';
let files=[];

(async()=>{try{const r=await fetch(WP.url+'/wp-json/filehub/v1/categories',{headers:{'X-Filehub-Key':WP.key}});const c=await r.json();if(Array.isArray(c)){const s=document.getElementById('category');c.forEach(x=>{const o=document.createElement('option');o.value=x.id;o.textContent=x.name;s.appendChild(o)})}}catch(e){}})();

const dz=document.getElementById('dropzone'),fi=document.getElementById('fileInput');
dz.onclick=()=>fi.click();
dz.ondragover=e=>{e.preventDefault();dz.classList.add('drag')};
dz.ondragleave=()=>dz.classList.remove('drag');
dz.ondrop=e=>{e.preventDefault();dz.classList.remove('drag');addFiles(e.dataTransfer.files)};
fi.onchange=()=>{addFiles(fi.files);fi.value=''};

function addFiles(l){for(let i=0;i<l.length;i++)files.push(l[i]);renderFiles()}
function removeFile(i){files.splice(i,1);renderFiles()}
function renderFiles(){
  const el=document.getElementById('filesList');
  if(!files.length){el.innerHTML='';return}
  const ic={'image':'üñºÔ∏è','application/pdf':'üìÑ','application/vnd':'üìä','text':'üìù'};
  el.innerHTML=files.map((f,i)=>{
    let icon='üìé';for(const[k,v]of Object.entries(ic))if(f.type.startsWith(k)){icon=v;break}
    const sz=f.size<1048576?(f.size/1024).toFixed(0)+' KB':(f.size/1048576).toFixed(1)+' MB';
    return`<div class="file-item"><span class="fi">${icon}</span><span class="fname">${f.name}</span><span class="fsize">${sz}</span><button class="fremove" onclick="removeFile(${i})">‚úï</button></div>`;
  }).join('');
}

function log(msg,type){
  const icons={info:'üîÑ',ok:'‚úÖ',err:'‚ùå',title:'‚úÖ'};
  document.getElementById('log').innerHTML+=`<div class="log-line ${type||'info'}"><span class="li">${icons[type]||'üîÑ'}</span><span>${msg}</span></div>`;
}

async function api(ep,opts){
  const o=Object.assign({},opts||{});if(!o.headers)o.headers={};o.headers['X-Filehub-Key']=WP.key;
  const r=await fetch(WP.url+'/wp-json/filehub/v1/'+ep,o);const d=await r.json();
  if(!r.ok)throw new Error(d?.error||'Error '+r.status);return d;
}
async function upload(file){
  const fd=new FormData();fd.append('file',file);
  const r=await fetch(WP.url+'/wp-json/filehub/v1/upload',{method:'POST',headers:{'X-Filehub-Key':WP.key},body:fd});
  const d=await r.json();if(!r.ok)throw new Error(d?.error||'Error subiendo');return d;
}
async function aiGen(text,imgs,docs){
  let ctx='';
  if(imgs.length)ctx+='\n\nIm√°genes:\n'+imgs.map((u,i)=>(i+1)+'. '+u).join('\n')+'\nIns√©rtalas con <img src="URL" alt="foto" style="max-width:100%;height:auto;border-radius:8px;margin:16px 0">.';
  if(docs.length)ctx+='\n\nDocumentos adjuntos para incluir como enlaces de descarga:\n'+docs.map(d=>'- '+d.name+': '+d.url).join('\n');
  const r=await fetch('https://api.groq.com/openai/v1/chat/completions',{
    method:'POST',headers:{'Authorization':'Bearer '+GROQ,'Content-Type':'application/json'},
    body:JSON.stringify({model:'llama-3.3-70b-versatile',max_tokens:4000,temperature:0.7,messages:[
      {role:'system',content:'Editor blog cartagenaeste.es (centro salud zona este Cartagena, Murcia). Responde SOLO JSON sin backticks: {"title":"titulo SEO","content":"<p>HTML completo</p>","excerpt":"resumen","tags":["tag1"],"category_suggestion":"cat"}. Si hay documentos adjuntos incluye al final del contenido: <div style="background:#f0f9ff;padding:16px;border-radius:12px;margin-top:24px"><h3>üìé Documentos adjuntos</h3><ul><li><a href="URL" target="_blank" style="color:#0369a1;font-weight:600">NOMBRE</a></li></ul></div>. Tono cercano, profesional, sanitario.'},
      {role:'user',content:'Genera entrada completa para el blog.\n\n'+text+ctx}
    ]})
  });
  if(!r.ok)throw new Error('Error IA');
  const d=await r.json();
  const t=(d.choices?.[0]?.message?.content||'').replace(/```json?\n?/g,'').replace(/```/g,'').trim();
  const m=t.match(/\{[\s\S]*\}/);if(!m)throw new Error('IA no gener√≥ formato correcto');
  return JSON.parse(m[0]);
}

async function doPublish(){
  const content=document.getElementById('content').value.trim();
  const status=document.getElementById('status').value;
  const catId=document.getElementById('category').value;
  if(!content&&!files.length){alert('Escribe algo o adjunta un archivo');return}
  const btn=document.getElementById('pubBtn');
  btn.disabled=true;btn.innerHTML='<div class="spinner"></div> Publicando...';
  document.getElementById('log').innerHTML='';document.getElementById('successBox').style.display='none';
  try{
    let media=[];
    if(files.length){
      log('Subiendo '+files.length+' archivo(s)...','info');
      for(const f of files){try{const m=await upload(f);media.push(m);log('‚Üì '+f.name,'ok')}catch(e){log(f.name+': '+e.message,'err')}}
      if(media.length)log('ID:'+media.map(m=>m.id).join(','),'ok');
    }
    const imgs=media.filter(m=>m.mime_type?.startsWith('image/')).map(m=>m.source_url);
    const docs=media.filter(m=>!m.mime_type?.startsWith('image/')).map(m=>({name:m.title||m.source_url.split('/').pop(),url:m.source_url}));
    log('Generando con IA...','info');
    const post=await aiGen(content||'Publicaci√≥n con archivos adjuntos',imgs,docs);
    log('T√≠tulo: "'+post.title+'"','title');
    let tagIds=[];
    if(post.tags?.length){for(const n of post.tags){try{const t=await api('tag',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({name:n})});if(t?.id)tagIds.push(t.id)}catch(e){}}}
    let catIds=[];
    if(catId)catIds=[parseInt(catId)];
    else if(post.category_suggestion){const sel=document.getElementById('category');for(let i=0;i<sel.options.length;i++){if(sel.options[i].textContent.toLowerCase().includes(post.category_suggestion.toLowerCase())){catIds=[parseInt(sel.options[i].value)];break}}}
    log('Publicando ('+status+')...','info');
    const wp={title:post.title,content:post.content,excerpt:post.excerpt||'',status};
    if(tagIds.length)wp.tags=tagIds;if(catIds.length)wp.categories=catIds;
    const img1=media.find(m=>m.mime_type?.startsWith('image/'));if(img1)wp.featured_media=img1.id;
    const res=await api('publish',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify(wp)});
    log('¬°PUBLICADO! ‚Üí '+res.link,'ok');
    const sb=document.getElementById('successBox');
    sb.innerHTML=`<div class="success"><h3>‚úÖ ¬°Publicado!</h3><div class="stitle">${post.title}</div><a href="${res.link}" target="_blank">üîó ${res.link}</a><br><button class="again" onclick="resetAll()">‚úèÔ∏è Nueva publicaci√≥n</button></div>`;
    sb.style.display='block';sb.scrollIntoView({behavior:'smooth',block:'center'});
  }catch(e){log('Error: '+e.message,'err')}
  finally{btn.disabled=false;btn.innerHTML='‚ö° Publicar autom√°ticamente'}
}
function resetAll(){
  document.getElementById('content').value='';files=[];renderFiles();
  document.getElementById('log').innerHTML='';document.getElementById('successBox').style.display='none';
  window.scrollTo({top:0,behavior:'smooth'});
}
</script>
</body>
</html>
