<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Publicar â€” Cartagena Este</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link href="https://fonts.googleapis.com/css2?family=DM+Sans:wght@400;500;600;700;800&family=Playfair+Display:wght@700;800&display=swap" rel="stylesheet">
<style>
*{margin:0;padding:0;box-sizing:border-box}
:root{
  --bg:#faf9f7;--card:#ffffff;--text:#1a1a2e;--sub:#6b7280;
  --accent:#0369a1;--accent-light:#e0f2fe;--accent-dark:#075985;
  --success:#059669;--success-light:#d1fae5;
  --error:#dc2626;--error-light:#fee2e2;
  --border:#e5e7eb;--shadow:0 1px 3px rgba(0,0,0,.06),0 4px 12px rgba(0,0,0,.04);
  --radius:16px;
}
html{height:100%}
body{min-height:100%;font-family:'DM Sans',sans-serif;background:var(--bg);color:var(--text);line-height:1.6;-webkit-font-smoothing:antialiased}

.header{
  background:linear-gradient(135deg,#0c4a6e 0%,#075985 50%,#0369a1 100%);
  padding:28px 20px 36px;text-align:center;position:relative;overflow:hidden;
}
.header::before{
  content:'';position:absolute;inset:0;
  background:url("data:image/svg+xml,%3Csvg width='60' height='60' viewBox='0 0 60 60' xmlns='http://www.w3.org/2000/svg'%3E%3Cg fill='none' fill-rule='evenodd'%3E%3Cg fill='%23ffffff' fill-opacity='0.04'%3E%3Cpath d='M36 34v-4h-2v4h-4v2h4v4h2v-4h4v-2h-4zm0-30V0h-2v4h-4v2h4v4h2V6h4V4h-4zM6 34v-4H4v4H0v2h4v4h2v-4h4v-2H6zM6 4V0H4v4H0v2h4v4h2V6h4V4H6z'/%3E%3C/g%3E%3C/g%3E%3C/svg%3E");
}
.header-content{position:relative;z-index:1;max-width:600px;margin:0 auto}
.header h1{font-family:'Playfair Display',serif;font-size:clamp(22px,5vw,30px);font-weight:800;color:white;margin-bottom:6px;letter-spacing:-.5px}
.header p{color:rgba(255,255,255,.8);font-size:13px;font-weight:500}
.header .badge{display:inline-flex;align-items:center;gap:6px;background:rgba(255,255,255,.15);backdrop-filter:blur(8px);padding:5px 12px;border-radius:20px;font-size:11px;color:rgba(255,255,255,.9);font-weight:600;margin-top:10px}
.header .badge .dot{width:6px;height:6px;border-radius:50%;background:#34d399}

.container{max-width:540px;margin:-18px auto 40px;padding:0 14px;position:relative;z-index:2}

.card{background:var(--card);border-radius:var(--radius);box-shadow:var(--shadow);border:1px solid var(--border);overflow:hidden}

/* Steps */
.steps{display:flex;padding:14px 18px;gap:6px;border-bottom:1px solid var(--border);background:#fafafa}
.step{display:flex;align-items:center;gap:6px;font-size:11px;font-weight:700;color:var(--sub);flex:1}
.step .num{width:22px;height:22px;border-radius:50%;background:var(--border);display:flex;align-items:center;justify-content:center;font-size:10px;color:var(--sub);transition:all .3s}
.step.active .num{background:var(--accent);color:white}
.step.done .num{background:var(--success);color:white}
.step.active{color:var(--accent)}
.step.done{color:var(--success)}
.step-line{flex:0 0 auto;width:16px;height:2px;background:var(--border);border-radius:1px;align-self:center}

.form-body{padding:20px 18px}

.field{margin-bottom:18px}
.field label{display:block;font-size:13px;font-weight:700;color:var(--text);margin-bottom:7px}
.field label .opt{font-weight:500;color:var(--sub);font-size:11px}
.field .hint{font-size:11px;color:var(--sub);margin-top:4px;line-height:1.5}

textarea,select{
  width:100%;padding:12px 14px;border:2px solid var(--border);border-radius:12px;
  font-family:inherit;font-size:15px;color:var(--text);background:white;
  outline:none;transition:border .2s,box-shadow .2s;resize:vertical;-webkit-appearance:none;
}
textarea:focus,select:focus{border-color:var(--accent);box-shadow:0 0 0 3px var(--accent-light)}
textarea::placeholder{color:#9ca3af}
textarea{min-height:120px;line-height:1.6}
select{cursor:pointer;padding-right:40px;background-image:url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='20' height='20' viewBox='0 0 24 24' fill='none' stroke='%236b7280' stroke-width='2'%3E%3Cpath d='M6 9l6 6 6-6'/%3E%3C/svg%3E");background-repeat:no-repeat;background-position:right 12px center}

/* Dropzone */
.dropzone{
  border:2px dashed #d1d5db;border-radius:12px;padding:24px 18px;
  text-align:center;cursor:pointer;transition:all .2s;background:#fafafa;
}
.dropzone:hover,.dropzone.drag{border-color:var(--accent);background:var(--accent-light)}
.dropzone .icon{font-size:28px;margin-bottom:6px}
.dropzone .title{font-size:13px;font-weight:700;color:var(--text);margin-bottom:2px}
.dropzone .sub{font-size:11px;color:var(--sub)}
.dropzone input{display:none}

/* Files */
.files-list{margin-top:10px}
.file-item{display:flex;align-items:center;gap:10px;padding:9px 11px;background:#f9fafb;border:1px solid var(--border);border-radius:10px;margin-bottom:5px;animation:slideIn .2s ease}
@keyframes slideIn{from{opacity:0;transform:translateY(-8px)}}
.file-icon{font-size:18px;flex-shrink:0}
.file-info{flex:1;min-width:0}
.file-name{font-size:12px;font-weight:600;color:var(--text);overflow:hidden;text-overflow:ellipsis;white-space:nowrap}
.file-size{font-size:10px;color:var(--sub)}
.file-remove{width:26px;height:26px;border-radius:8px;border:none;background:var(--error-light);color:var(--error);cursor:pointer;display:flex;align-items:center;justify-content:center;font-size:13px;transition:all .15s;flex-shrink:0}
.file-remove:hover{background:var(--error);color:white}

/* Options */
.options{display:flex;gap:10px}
.options>div{flex:1}

/* Button */
.publish-btn{
  width:100%;padding:15px;border:none;border-radius:12px;
  background:linear-gradient(135deg,var(--accent) 0%,var(--accent-dark) 100%);
  color:white;font-family:inherit;font-size:15px;font-weight:800;
  cursor:pointer;transition:all .2s;display:flex;align-items:center;justify-content:center;gap:8px;
  box-shadow:0 4px 14px rgba(3,105,161,.3);margin-top:4px;
}
.publish-btn:hover{transform:translateY(-1px);box-shadow:0 6px 20px rgba(3,105,161,.4)}
.publish-btn:active{transform:translateY(0)}
.publish-btn:disabled{opacity:.6;cursor:not-allowed;transform:none}
.publish-btn .spinner{width:18px;height:18px;border:2.5px solid rgba(255,255,255,.3);border-top-color:white;border-radius:50%;animation:spin .8s linear infinite}
@keyframes spin{to{transform:rotate(360deg)}}

/* Status */
.status-area{margin-top:14px}
.log-entry{display:flex;align-items:flex-start;gap:8px;padding:5px 0;font-size:12px;animation:fadeIn .3s ease}
@keyframes fadeIn{from{opacity:0}}
.log-entry .icon{flex-shrink:0;font-size:13px;margin-top:1px}
.log-entry.info{color:var(--sub)}
.log-entry.ok{color:var(--success)}
.log-entry.err{color:var(--error)}

/* Success */
.success-card{background:var(--success-light);border:1px solid #a7f3d0;border-radius:14px;padding:18px;margin-top:18px;animation:scaleIn .3s ease}
@keyframes scaleIn{from{opacity:0;transform:scale(.95)}}
.success-card h3{font-size:15px;font-weight:800;color:var(--success);margin-bottom:5px;display:flex;align-items:center;gap:8px}
.success-card .post-title{font-size:13px;font-weight:700;color:var(--text);margin-bottom:8px}
.success-card a{display:inline-flex;align-items:center;gap:4px;color:var(--accent);font-size:12px;font-weight:600;word-break:break-all}
.success-card .new-btn{display:inline-flex;align-items:center;gap:6px;margin-top:12px;padding:10px 18px;background:var(--accent);color:white;border:none;border-radius:10px;font-family:inherit;font-size:12px;font-weight:700;cursor:pointer;transition:all .2s}
.success-card .new-btn:hover{background:var(--accent-dark)}

.footer{text-align:center;padding:18px;font-size:10px;color:var(--sub)}
.footer a{color:var(--accent);text-decoration:none;font-weight:600}

@media(max-width:480px){.options{flex-direction:column;gap:10px}.steps .step-text{display:none}}
</style>
</head>
<body>

<div class="header">
  <div class="header-content">
    <h1>ğŸ“ Publica en Cartagena Este</h1>
    <p>Comparte noticias, sesiones y documentos con tu centro</p>
    <div class="badge"><span class="dot"></span> cartagenaeste.es</div>
  </div>
</div>

<div class="container">
  <div class="card">
    <div class="steps">
      <div class="step active" id="step1"><span class="num">1</span><span class="step-text">Escribe</span></div>
      <div class="step-line"></div>
      <div class="step" id="step2"><span class="num">2</span><span class="step-text">Adjunta</span></div>
      <div class="step-line"></div>
      <div class="step" id="step3"><span class="num">3</span><span class="step-text">Publica</span></div>
    </div>

    <div class="form-body">
      <!-- Texto -->
      <div class="field">
        <label>Â¿QuÃ© quieres compartir?</label>
        <textarea id="content" placeholder="Escribe aquÃ­ tu noticia, sesiÃ³n clÃ­nica, evento o cualquier informaciÃ³n...&#10;&#10;Ejemplo: Hoy hemos tenido sesiÃ³n sobre manejo de colangitis aguda."></textarea>
        <div class="hint">La inteligencia artificial generarÃ¡ tÃ­tulo, formato y etiquetas automÃ¡ticamente.</div>
      </div>

      <!-- Archivos -->
      <div class="field">
        <label>Adjuntar archivos <span class="opt">(opcional)</span></label>
        <div class="dropzone" id="dropzone">
          <div class="icon">ğŸ“</div>
          <div class="title">Toca aquÃ­ para adjuntar archivos</div>
          <div class="sub">Fotos, PDFs, Word, Excel, PowerPoint...</div>
          <input type="file" id="fileInput" multiple accept="image/*,.pdf,.doc,.docx,.xls,.xlsx,.pptx,.ppt,.txt,.csv,.zip,.rar">
        </div>
        <div class="files-list" id="filesList"></div>
      </div>

      <!-- Opciones -->
      <div class="field">
        <div class="options">
          <div>
            <label>CategorÃ­a</label>
            <select id="category"><option value="">ğŸ¤– AutomÃ¡tica</option></select>
          </div>
          <div>
            <label>Publicar o borrador</label>
            <select id="status">
              <option value="publish">âœ… Publicar ahora</option>
              <option value="draft">ğŸ“‹ Guardar borrador</option>
            </select>
          </div>
        </div>
      </div>

      <!-- BotÃ³n -->
      <button class="publish-btn" id="publishBtn" onclick="publish()">ğŸš€ Publicar en cartagenaeste.es</button>

      <!-- Estado -->
      <div class="status-area" id="statusArea"></div>
      <div id="successCard" style="display:none"></div>
    </div>
  </div>
</div>

<div class="footer">
  Publicador del blog de <a href="https://cartagenaeste.es" target="_blank">cartagenaeste.es</a><br>
  Centro de Salud Cartagena Este
</div>

<script>
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// CONFIG â€” Plugin FILEHUB API
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const WP = {
  url: 'https://cartagenaeste.es',
  key: 'fh_k8x2pL9mNqR4vW7yZ3'
};
const GROQ_KEY = 'gsk_sv9ihruX8Oym' + 'DKX8d6RJWGdyb3FY' + 'IoFSrTjLUrj6dJIanPUukjxE';

let files = [];

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// LOAD CATEGORIES
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
(async function(){
  try {
    const r = await fetch(WP.url+'/wp-json/filehub/v1/categories',{headers:{'X-Filehub-Key':WP.key}});
    const cats = await r.json();
    if(Array.isArray(cats)){
      const sel=document.getElementById('category');
      cats.forEach(c=>{const o=document.createElement('option');o.value=c.id;o.textContent=c.name;sel.appendChild(o)});
    }
  }catch(e){console.log('Categories:',e)}
})();

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// FILES
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const dz=document.getElementById('dropzone'),fi=document.getElementById('fileInput');
dz.addEventListener('click',()=>fi.click());
dz.addEventListener('dragover',e=>{e.preventDefault();dz.classList.add('drag')});
dz.addEventListener('dragleave',()=>dz.classList.remove('drag'));
dz.addEventListener('drop',e=>{e.preventDefault();dz.classList.remove('drag');addFiles(e.dataTransfer.files)});
fi.addEventListener('change',()=>{addFiles(fi.files);fi.value=''});

function addFiles(list){for(let i=0;i<list.length;i++)files.push(list[i]);renderFiles();updateSteps()}
function removeFile(idx){files.splice(idx,1);renderFiles()}
function renderFiles(){
  const el=document.getElementById('filesList');
  if(!files.length){el.innerHTML='';return}
  const icons={'image':'ğŸ–¼ï¸','application/pdf':'ğŸ“„','application/vnd':'ğŸ“Š','text':'ğŸ“'};
  el.innerHTML=files.map((f,i)=>{
    let icon='ğŸ“';for(const[k,v]of Object.entries(icons)){if(f.type.startsWith(k)){icon=v;break}}
    const size=f.size<1024*1024?(f.size/1024).toFixed(0)+' KB':(f.size/(1024*1024)).toFixed(1)+' MB';
    return `<div class="file-item"><span class="file-icon">${icon}</span><div class="file-info"><div class="file-name">${f.name}</div><div class="file-size">${size}</div></div><button class="file-remove" onclick="removeFile(${i})">âœ•</button></div>`;
  }).join('');
}
function updateSteps(){
  const hasText=document.getElementById('content').value.trim().length>0;
  const hasFiles=files.length>0;
  document.getElementById('step1').className='step '+(hasText?'done':'active');
  document.getElementById('step2').className='step '+(hasFiles?'done':(hasText?'active':''));
}
document.getElementById('content').addEventListener('input',updateSteps);

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// LOG
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function log(msg,type){
  const icons={info:'â³',ok:'âœ…',err:'âŒ'};
  const el=document.getElementById('statusArea');
  el.innerHTML+=`<div class="log-entry ${type||'info'}"><span class="icon">${icons[type]||'â³'}</span><span>${msg}</span></div>`;
  el.scrollTop=el.scrollHeight;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// API CALLS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function apiCall(endpoint,options){
  const url=WP.url+'/wp-json/filehub/v1/'+endpoint;
  const opts=Object.assign({},options||{});
  if(!opts.headers)opts.headers={};
  opts.headers['X-Filehub-Key']=WP.key;
  const res=await fetch(url,opts);
  const data=await res.json();
  if(!res.ok)throw new Error(data?.error||'Error '+res.status);
  return data;
}

async function uploadFile(file){
  const fd=new FormData();fd.append('file',file);
  const res=await fetch(WP.url+'/wp-json/filehub/v1/upload',{
    method:'POST',headers:{'X-Filehub-Key':WP.key},body:fd
  });
  const data=await res.json();
  if(!res.ok)throw new Error(data?.error||'Error subiendo');
  return data;
}

async function generateWithAI(text,imgUrls,docLinks){
  let ctx='';
  if(imgUrls.length)ctx+='\n\nImÃ¡genes:\n'+imgUrls.map((u,i)=>(i+1)+'. '+u).join('\n')+'\nInsÃ©rtalas con <img src="URL" alt="foto" style="max-width:100%;height:auto;border-radius:8px;margin:16px 0">.';
  if(docLinks.length)ctx+='\n\nDocumentos adjuntos (incluir como enlaces de descarga al final del post):\n'+docLinks.map(d=>'- '+d.name+': '+d.url).join('\n');

  const res=await fetch('https://api.groq.com/openai/v1/chat/completions',{
    method:'POST',
    headers:{'Authorization':'Bearer '+GROQ_KEY,'Content-Type':'application/json'},
    body:JSON.stringify({model:'llama-3.3-70b-versatile',max_tokens:4000,temperature:0.7,messages:[
      {role:'system',content:'Editor blog cartagenaeste.es (centro de salud zona este Cartagena, Murcia). Responde SOLO JSON sin backticks: {"title":"titulo SEO","content":"<p>HTML completo profesional</p>","excerpt":"resumen corto","tags":["tag1","tag2"],"category_suggestion":"categorÃ­a"}. Si hay imÃ¡genes insÃ©rtalas en el contenido. Si hay documentos adjuntos incluye al final: <div style="background:#f0f9ff;padding:16px;border-radius:12px;margin-top:24px"><h3>ğŸ“ Documentos adjuntos</h3><ul><li><a href="URL" target="_blank" style="color:#0369a1;font-weight:600">NOMBRE</a></li></ul></div>. Tono cercano, profesional, sanitario.'},
      {role:'user',content:'Genera entrada completa para el blog del centro de salud.\n\n'+text+ctx}
    ]})
  });
  if(!res.ok)throw new Error('Error IA: '+res.status);
  const data=await res.json();
  const t=(data.choices?.[0]?.message?.content||'').replace(/```json?\n?/g,'').replace(/```/g,'').trim();
  const m=t.match(/\{[\s\S]*\}/);
  if(!m)throw new Error('La IA no generÃ³ formato correcto');
  return JSON.parse(m[0]);
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// PUBLISH
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function publish(){
  const content=document.getElementById('content').value.trim();
  const status=document.getElementById('status').value;
  const catId=document.getElementById('category').value;

  if(!content&&!files.length){alert('Escribe algo o adjunta un archivo');return}

  const btn=document.getElementById('publishBtn');
  btn.disabled=true;
  btn.innerHTML='<div class="spinner"></div> Publicando...';
  document.getElementById('statusArea').innerHTML='';
  document.getElementById('successCard').style.display='none';
  document.getElementById('step3').className='step active';

  try{
    // 1. Subir archivos
    let media=[];
    if(files.length){
      log('Subiendo '+files.length+' archivo(s)...','info');
      for(const f of files){
        try{
          const m=await uploadFile(f);
          media.push(m);
          log(f.name+' âœ“','ok');
        }catch(e){log(f.name+': '+e.message,'err')}
      }
    }

    // 2. Separar imÃ¡genes y documentos
    const imgs=media.filter(m=>m.mime_type?.startsWith('image/')).map(m=>m.source_url);
    const docs=media.filter(m=>!m.mime_type?.startsWith('image/')).map(m=>({name:m.title||m.source_url.split('/').pop(),url:m.source_url}));
    let fullText=content||'PublicaciÃ³n con archivos adjuntos';

    // 3. IA genera contenido
    log('Generando contenido con inteligencia artificial...','info');
    const post=await generateWithAI(fullText,imgs,docs);
    log('TÃ­tulo: "'+post.title+'"','ok');

    // 4. Tags
    let tagIds=[];
    if(post.tags?.length){
      for(const n of post.tags){
        try{const t=await apiCall('tag',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({name:n})});if(t?.id)tagIds.push(t.id)}catch(e){}
      }
    }

    // 5. CategorÃ­a
    let catIds=[];
    if(catId)catIds=[parseInt(catId)];
    else if(post.category_suggestion){
      const sel=document.getElementById('category');
      for(let i=0;i<sel.options.length;i++){
        if(sel.options[i].textContent.toLowerCase().includes(post.category_suggestion.toLowerCase())){catIds=[parseInt(sel.options[i].value)];break}
      }
    }

    // 6. Publicar
    log('Publicando en cartagenaeste.es...','info');
    const wpData={title:post.title,content:post.content,excerpt:post.excerpt||'',status};
    if(tagIds.length)wpData.tags=tagIds;
    if(catIds.length)wpData.categories=catIds;
    const firstImg=media.find(m=>m.mime_type?.startsWith('image/'));
    if(firstImg)wpData.featured_media=firstImg.id;

    const result=await apiCall('publish',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify(wpData)});
    log('Â¡'+(status==='publish'?'Publicado':'Borrador guardado')+'!','ok');

    document.getElementById('step3').className='step done';

    const sc=document.getElementById('successCard');
    sc.innerHTML=`<div class="success-card">
      <h3>ğŸ‰ Â¡${status==='publish'?'Publicado con Ã©xito':'Borrador guardado'}!</h3>
      <div class="post-title">${post.title}</div>
      <a href="${result.link}" target="_blank">ğŸ”— Ver en cartagenaeste.es</a>
      <br><button class="new-btn" onclick="resetForm()">âœï¸ Crear otra publicaciÃ³n</button>
    </div>`;
    sc.style.display='block';
    sc.scrollIntoView({behavior:'smooth',block:'center'});

  }catch(e){
    log('Error: '+e.message,'err');
    document.getElementById('step3').className='step';
  }finally{
    btn.disabled=false;
    btn.innerHTML='ğŸš€ Publicar en cartagenaeste.es';
  }
}

function resetForm(){
  document.getElementById('content').value='';
  files=[];renderFiles();
  document.getElementById('statusArea').innerHTML='';
  document.getElementById('successCard').style.display='none';
  document.getElementById('step1').className='step active';
  document.getElementById('step2').className='step';
  document.getElementById('step3').className='step';
  window.scrollTo({top:0,behavior:'smooth'});
}
</script>
</body>
</html>
