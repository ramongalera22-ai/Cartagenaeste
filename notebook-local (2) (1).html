<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cuaderno Medical AI Local - Cartagena Este</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #f0f4f8 0%, #e9f0f7 100%);
            color: #333; height: 100vh; overflow: hidden;
        }
        .container { display: grid; grid-template-columns: 280px 1fr 320px; height: 100vh; gap: 0; }
        .sidebar-left { background: white; border-right: 1px solid #e0e0e0; display: flex; flex-direction: column; box-shadow: 2px 0 8px rgba(0,0,0,0.05); }
        .sidebar-header { padding: 20px; background: linear-gradient(135deg, #0066cc 0%, #004499 100%); color: white; border-bottom: 1px solid #ddd; }
        .sidebar-header h2 { font-size: 1.1rem; margin-bottom: 5px; }
        .sidebar-header p { font-size: 0.8rem; opacity: 0.9; }
        .categories-list { flex: 1; overflow-y: auto; padding: 10px 0; }
        .category-btn { display: block; width: 100%; padding: 15px 20px; text-align: left; border: none; background: transparent; cursor: pointer; transition: all 0.3s; font-size: 0.9rem; color: #333; border-left: 3px solid transparent; font-family: inherit; }
        .category-btn:hover { background: #f5f5f5; border-left-color: #0066cc; }
        .category-btn.active { background: #f0f7ff; border-left-color: #0066cc; color: #0066cc; font-weight: 600; }
        .main-content { display: flex; flex-direction: column; background: white; }
        .content-header { padding: 20px; border-bottom: 1px solid #e0e0e0; background: #f9f9f9; display: flex; justify-content: space-between; align-items: center; }
        .content-header h3 { font-size: 1.4rem; color: #0066cc; }
        .ollama-status { padding: 6px 12px; border-radius: 20px; font-size: 0.85rem; font-weight: 600; }
        .ollama-status.connected { background: #d4edda; color: #155724; }
        .ollama-status.disconnected { background: #f8d7da; color: #721c24; }
        .ollama-status.checking { background: #fff3cd; color: #856404; }
        .content-area { flex: 1; overflow-y: auto; padding: 20px; }
        .tab-buttons { display: flex; gap: 10px; margin-bottom: 20px; border-bottom: 2px solid #e0e0e0; padding-bottom: 10px; }
        .tab-btn { padding: 10px 20px; border: none; background: transparent; cursor: pointer; color: #666; font-weight: 600; transition: all 0.3s; border-bottom: 3px solid transparent; margin-bottom: -13px; font-family: inherit; }
        .tab-btn.active { color: #0066cc; border-bottom-color: #0066cc; }
        .tab-btn:hover:not(.active) { color: #444; }
        .tab-content { display: none; }
        .tab-content.active { display: block; animation: fadeIn 0.3s ease; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        .question-input { display: flex; gap: 10px; margin-bottom: 15px; }
        .question-input input { flex: 1; padding: 12px; border: 1px solid #e0e0e0; border-radius: 8px; font-size: 0.95rem; font-family: inherit; }
        .question-input input:focus { outline: none; border-color: #0066cc; box-shadow: 0 0 0 3px rgba(0,102,204,0.1); }
        .btn { padding: 10px 20px; border: none; border-radius: 6px; cursor: pointer; font-weight: 600; transition: all 0.3s; font-family: inherit; }
        .btn-primary { background: #0066cc; color: white; }
        .btn-primary:hover:not(:disabled) { background: #004499; box-shadow: 0 4px 12px rgba(0,102,204,0.3); }
        .btn-primary:disabled { background: #ccc; cursor: not-allowed; }
        .btn-secondary { background: #f0f0f0; color: #333; }
        .btn-secondary:hover { background: #e0e0e0; }
        .btn-small { padding: 7px 14px; font-size: 0.85rem; }
        .question-box { background: white; padding: 15px; border-radius: 8px; margin-bottom: 15px; border-left: 3px solid #0066cc; animation: slideIn 0.3s ease; box-shadow: 0 1px 4px rgba(0,0,0,0.06); }
        @keyframes slideIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .question-text { color: #0066cc; font-weight: 600; margin-bottom: 10px; font-size: 0.95rem; }
        .answer-text { color: #555; line-height: 1.6; font-size: 0.95rem; white-space: pre-wrap; word-wrap: break-word; }
        .note-time { font-size: 0.8rem; color: #999; margin-top: 10px; }
        .doc-item { background: #f9f9f9; padding: 10px; border-radius: 6px; margin-bottom: 8px; border-left: 2px solid #0066cc; display: flex; justify-content: space-between; align-items: center; }
        .doc-info { flex: 1; }
        .doc-name { font-weight: 600; color: #333; font-size: 0.9rem; margin-bottom: 3px; }
        .doc-size { font-size: 0.8rem; color: #999; }
        .doc-btn { background: #0066cc; color: white; padding: 6px 12px; border: none; border-radius: 4px; cursor: pointer; font-size: 0.85rem; white-space: nowrap; text-decoration: none; }
        .doc-btn:hover { background: #004499; }
        .empty-state { text-align: center; padding: 40px 20px; color: #999; }
        .empty-state-icon { font-size: 3rem; margin-bottom: 15px; }
        .studio-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 16px; }
        .studio-card { background: #f8f9fa; border: 1px solid #e0e0e0; border-radius: 10px; padding: 14px; cursor: pointer; transition: all 0.2s; text-align: left; font-family: inherit; }
        .studio-card:hover:not(:disabled) { border-color: #0066cc; box-shadow: 0 2px 8px rgba(0,102,204,0.12); transform: translateY(-1px); }
        .studio-card:disabled { opacity: 0.4; cursor: not-allowed; }
        .studio-card-icon { font-size: 1.4rem; margin-bottom: 6px; }
        .studio-card-title { font-weight: 600; font-size: 0.9rem; color: #333; margin-bottom: 2px; }
        .studio-card-desc { font-size: 0.8rem; color: #888; }
        .config-box { background: #f0f7ff; border: 1px solid #b8d4f0; border-radius: 10px; padding: 16px; margin-bottom: 16px; }
        .config-box h4 { color: #0066cc; margin-bottom: 10px; font-size: 0.95rem; }
        .config-row { display: flex; gap: 8px; margin-bottom: 8px; align-items: center; }
        .config-row input, .config-row select { flex: 1; padding: 8px 12px; border: 1px solid #ddd; border-radius: 6px; font-size: 0.88rem; font-family: inherit; }
        .config-row input:focus, .config-row select:focus { outline: none; border-color: #0066cc; }
        .config-hint { font-size: 0.8rem; color: #888; margin-top: 4px; }
        .sidebar-right { background: linear-gradient(135deg, #f5f7fa 0%, #e8ecf1 100%); border-left: 1px solid #e0e0e0; padding: 20px; overflow-y: auto; box-shadow: -2px 0 8px rgba(0,0,0,0.05); }
        .sidebar-section-title { font-weight: 600; margin: 0 0 15px 0; color: #0066cc; font-size: 1rem; }
        .stat-card { background: white; padding: 12px; border-radius: 8px; margin-bottom: 10px; border-left: 3px solid #0066cc; }
        .stat-label { font-size: 0.8rem; color: #999; margin-bottom: 5px; }
        .stat-value { font-size: 1.4rem; font-weight: 700; color: #0066cc; }
        .info-box { background: #f0f7ff; padding: 12px; border-radius: 8px; border-left: 3px solid #0066cc; font-size: 0.85rem; line-height: 1.5; color: #333; }
        .model-badge { display: inline-block; background: #e8f4fd; color: #0066cc; padding: 3px 10px; border-radius: 12px; font-size: 0.78rem; font-weight: 600; font-family: Consolas, monospace; }
        .scrollbar::-webkit-scrollbar { width: 8px; }
        .scrollbar::-webkit-scrollbar-track { background: transparent; }
        .scrollbar::-webkit-scrollbar-thumb { background: #ccc; border-radius: 4px; }
        @media (max-width: 960px) { .container { grid-template-columns: 1fr; } .sidebar-left, .sidebar-right { display: none; } }
    </style>
</head>
<body>
    <div class="container">
        <div class="sidebar-left scrollbar">
            <div class="sidebar-header"><h2>üìö Categor√≠as</h2><p>IA Local Ollama</p></div>
            <div class="categories-list" id="categoriesList"></div>
        </div>
        <div class="main-content">
            <div class="content-header">
                <h3 id="categoryTitle">Cardiolog√≠a</h3>
                <span id="statusOllama" class="ollama-status checking">‚è≥ Conectando...</span>
            </div>
            <div class="content-area scrollbar">
                <div class="tab-buttons">
                    <button class="tab-btn active" onclick="switchTab('preguntas',this)">ü§ñ Preguntas IA</button>
                    <button class="tab-btn" onclick="switchTab('documentos',this)">üìö Documentos</button>
                    <button class="tab-btn" onclick="switchTab('notas',this)">üìù Notas</button>
                    <button class="tab-btn" onclick="switchTab('studio',this)">‚ú® Studio</button>
                    <button class="tab-btn" onclick="switchTab('config',this)">‚öôÔ∏è</button>
                </div>

                <div id="preguntas" class="tab-content active">
                    <div class="question-input">
                        <input type="text" id="preguntaInput" placeholder="Pregunta sobre los documentos..." spellcheck="false">
                        <button class="btn btn-primary" onclick="hacerPregunta()" id="btnPreguntar">Preguntar</button>
                    </div>
                    <div id="preguntasList"><div class="empty-state"><div class="empty-state-icon">‚ùì</div><p>Haz preguntas usando IA local</p></div></div>
                </div>

                <div id="documentos" class="tab-content"><div id="documentosList" style="margin-top:10px;"></div></div>

                <div id="notas" class="tab-content">
                    <div style="margin-bottom:20px;">
                        <textarea id="noteInput" placeholder="Escribe tus notas..." style="width:100%;padding:12px;border:1px solid #e0e0e0;border-radius:8px;min-height:80px;font-family:inherit;resize:vertical;"></textarea>
                        <div style="margin-top:10px;display:flex;gap:10px;">
                            <button class="btn btn-primary btn-small" onclick="agregarNota()">‚úì Guardar</button>
                            <button class="btn btn-secondary btn-small" onclick="limpiarEditor()">Limpiar</button>
                        </div>
                    </div>
                    <div id="notasList"></div>
                </div>

                <div id="studio" class="tab-content">
                    <div style="background:linear-gradient(135deg,#e8f4fd,#f0e8fd);border:1px solid #b8d4f0;border-radius:10px;padding:16px;margin-bottom:16px;">
                        <h4 style="color:#0066cc;margin-bottom:6px;">‚ú® AI Studio</h4>
                        <p style="font-size:0.88rem;color:#555;line-height:1.5;">Genera contenido autom√°tico sobre <strong id="studioCategory">Cardiolog√≠a</strong> usando tu IA local.</p>
                    </div>
                    <div class="studio-grid">
                        <button class="studio-card" onclick="studioAction('resumen')"><div class="studio-card-icon">üìã</div><div class="studio-card-title">Resumen ejecutivo</div><div class="studio-card-desc">Puntos clave de la especialidad</div></button>
                        <button class="studio-card" onclick="studioAction('faq')"><div class="studio-card-icon">‚ùì</div><div class="studio-card-title">FAQ</div><div class="studio-card-desc">Preguntas frecuentes</div></button>
                        <button class="studio-card" onclick="studioAction('guia')"><div class="studio-card-icon">üìñ</div><div class="studio-card-title">Gu√≠a de estudio</div><div class="studio-card-desc">Conceptos clave y repaso</div></button>
                        <button class="studio-card" onclick="studioAction('diagnostico')"><div class="studio-card-icon">ü©∫</div><div class="studio-card-title">Diagn√≥stico diferencial</div><div class="studio-card-desc">Patolog√≠as principales</div></button>
                        <button class="studio-card" onclick="studioAction('farmacologia')"><div class="studio-card-icon">üíä</div><div class="studio-card-title">Farmacolog√≠a</div><div class="studio-card-desc">F√°rmacos y dosis clave</div></button>
                        <button class="studio-card" onclick="studioAction('emergencia')"><div class="studio-card-icon">üö®</div><div class="studio-card-title">Protocolo emergencia</div><div class="studio-card-desc">Actuaci√≥n urgente</div></button>
                    </div>
                    <div id="studioResult" style="display:none;">
                        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px;">
                            <h4 style="color:#0066cc;" id="studioResultTitle"></h4>
                            <button class="btn btn-primary btn-small" onclick="guardarStudioComoNota()">üíæ Guardar como nota</button>
                        </div>
                        <div id="studioResultContent" class="scrollbar" style="background:#fafafa;border:1px solid #e0e0e0;border-radius:8px;padding:16px;line-height:1.65;font-size:0.95rem;white-space:pre-wrap;max-height:400px;overflow-y:auto;"></div>
                    </div>
                </div>

                <div id="config" class="tab-content">
                    <div class="config-box">
                        <h4>üîå Conexi√≥n a Ollama</h4>
                        <div class="config-row">
                            <input type="text" id="cfgUrl" placeholder="http://localhost:11434">
                            <button class="btn btn-primary btn-small" onclick="testConnection()">Probar</button>
                        </div>
                        <p class="config-hint">Local: http://localhost:11434 ¬∑ Remoto: https://tu-tunnel.trycloudflare.com</p>
                        <h4 style="margin-top:14px;">ü§ñ Modelo</h4>
                        <div class="config-row"><select id="cfgModel"><option>Cargando...</option></select></div>
                        <p class="config-hint">Se detectan autom√°ticamente los modelos instalados en Ollama</p>
                        <h4 style="margin-top:14px;">üîë API Key (solo si usas proxy autenticado)</h4>
                        <div class="config-row"><input type="password" id="cfgApiKey" placeholder="Dejar vac√≠o si no usas proxy"></div>
                        <div style="margin-top:14px;display:flex;gap:8px;">
                            <button class="btn btn-primary btn-small" onclick="guardarConfig()">üíæ Guardar</button>
                            <button class="btn btn-secondary btn-small" onclick="resetConfig()">‚Ü©Ô∏è Por defecto</button>
                        </div>
                        <div id="cfgStatus" style="margin-top:10px;"></div>
                    </div>
                </div>
            </div>
        </div>
        <div class="sidebar-right scrollbar">
            <div class="sidebar-section-title">üìä Estad√≠sticas</div>
            <div class="stat-card"><div class="stat-label">Documentos</div><div class="stat-value" id="docsCount">0</div></div>
            <div class="stat-card"><div class="stat-label">Preguntas</div><div class="stat-value" id="preguntasCount">0</div></div>
            <div class="stat-card"><div class="stat-label">Notas</div><div class="stat-value" id="notasCount">0</div></div>
            <div style="margin-top:15px;"><div class="sidebar-section-title">ü§ñ Modelo</div>
                <div class="stat-card"><span class="model-badge" id="modelBadge">--</span><div style="font-size:0.8rem;color:#999;margin-top:6px;" id="modelInfo">Conectando...</div></div>
            </div>
            <div class="info-box" style="margin-top:15px;"><strong>üí° IA Local</strong><br>Modelo ejecutado localmente v√≠a Ollama.<br><br><strong>‚úÖ Ventajas:</strong><br>‚Ä¢ Sin API key<br>‚Ä¢ Ilimitado<br>‚Ä¢ Completamente gratis<br>‚Ä¢ Datos privados</div>
        </div>
    </div>

<script>
const categories={"Cardiolog√≠a":"‚ù§Ô∏è","Dermatolog√≠a":"ü©π","Digestivo":"ü´Å","Endocrinolog√≠a":"üß¨","Geriatr√≠a":"üë¥","Ginecolog√≠a":"ü§∞","Neurolog√≠a":"üß†","Neumolog√≠a":"üí®","Pediatr√≠a":"üë∂","Traumatolog√≠a":"ü¶¥","Protocolos M√©dicos":"üìã"};
let currentCategory="Cardiolog√≠a",documents={},preguntas={},notas={},ollamaConnected=false,availableModels=[],isProcessing=false;
let CONFIG={url:"http://localhost:11434",model:"qwen2.5-coder:7b",apiKey:""};
try{const s=localStorage.getItem("notebook_config_v2");if(s)Object.assign(CONFIG,JSON.parse(s));}catch(e){}

function getHeaders(){const h={"Content-Type":"application/json"};if(CONFIG.apiKey)h["X-API-Key"]=CONFIG.apiKey;return h;}

async function checkOllamaConnection(){
    setStatus("checking");
    try{
        const r=await fetch(CONFIG.url+"/api/tags",{headers:getHeaders(),signal:AbortSignal.timeout(6000)});
        if(r.ok){
            const d=await r.json();
            availableModels=(d.models||[]).map(m=>m.name);
            ollamaConnected=true;
            if(availableModels.length>0&&!availableModels.includes(CONFIG.model)){
                console.warn("Modelo",CONFIG.model,"no encontrado. Usando:",availableModels[0]);
                CONFIG.model=availableModels[0];
                saveConfigSilent();
            }
            setStatus("connected");updateModelUI();
            console.log("‚úÖ Ollama OK:",availableModels.join(", "));
            return true;
        }
        if(r.status===401)setStatus("disconnected","API Key incorrecta");
        else setStatus("disconnected","Error "+r.status);
    }catch(e){setStatus("disconnected");console.log("Ollama no disponible:",e.message);}
    ollamaConnected=false;return false;
}

function setStatus(s,m){
    const el=document.getElementById("statusOllama");
    if(s==="connected"){el.className="ollama-status connected";const rm=!CONFIG.url.includes("localhost")&&!CONFIG.url.includes("127.0.0.1");el.textContent=rm?"‚úÖ Ollama Remoto":"‚úÖ Ollama Conectado";}
    else if(s==="checking"){el.className="ollama-status checking";el.textContent="‚è≥ Conectando...";}
    else{el.className="ollama-status disconnected";el.textContent=m?"‚ùå "+m:"‚ùå Desconectado";}
}

function updateModelUI(){
    document.getElementById("modelBadge").textContent=CONFIG.model;
    const rm=!CONFIG.url.includes("localhost")&&!CONFIG.url.includes("127.0.0.1");
    document.getElementById("modelInfo").textContent=(rm?"Remoto":"Local")+" ¬∑ "+availableModels.length+" modelo(s)";
    const sel=document.getElementById("cfgModel");
    sel.innerHTML=availableModels.length===0?'<option value="">Sin modelos</option>':availableModels.map(m=>'<option value="'+m+'"'+(m===CONFIG.model?" selected":"")+">"+m+"</option>").join("");
    const sc=document.getElementById("studioCategory");if(sc)sc.textContent=currentCategory;
}

async function llamarOllama(userPrompt,systemPrompt,onChunk){
    const msgs=[];
    if(systemPrompt)msgs.push({role:"system",content:systemPrompt});
    msgs.push({role:"user",content:userPrompt});
    const useStream=typeof onChunk==="function";
    try{
        const r=await fetch(CONFIG.url+"/api/chat",{
            method:"POST",headers:getHeaders(),
            body:JSON.stringify({model:CONFIG.model,messages:msgs,stream:useStream,options:{temperature:0.7,num_predict:2048}})
        });
        if(!r.ok){if(r.status===401)return"‚ùå API Key incorrecta.";return"‚ùå Error HTTP "+r.status;}
        if(useStream){
            const reader=r.body.getReader(),dec=new TextDecoder();let full="";
            while(true){
                const{done,value}=await reader.read();if(done)break;
                const lines=dec.decode(value,{stream:true}).split("\n").filter(l=>l.trim());
                for(const line of lines){try{const j=JSON.parse(line);if(j.message&&j.message.content){full+=j.message.content;onChunk(full);}}catch(e){}}
            }
            return full||"Sin respuesta.";
        }
        const d=await r.json();return(d.message&&d.message.content)||"Sin respuesta.";
    }catch(e){console.error("Ollama error:",e);return"‚ùå Error: "+e.message;}
}

async function hacerPregunta(){
    const input=document.getElementById("preguntaInput"),pregunta=input.value.trim();
    if(!pregunta||isProcessing)return;
    if(!ollamaConnected){alert("‚ö†Ô∏è Ollama no conectado. Ve a ‚öôÔ∏è Config.");return;}
    isProcessing=true;document.getElementById("btnPreguntar").disabled=true;
    if(!preguntas[currentCategory])preguntas[currentCategory]=[];
    const idx=preguntas[currentCategory].length;
    preguntas[currentCategory].push({pregunta:pregunta,respuesta:"‚è≥ Procesando...",fecha:new Date().toLocaleString("es-ES")});
    input.value="";actualizarUI();
    const docs=documents[currentCategory]||[];
    const docsCtx=docs.map(d=>"- "+d.name+" ("+d.type+")").join("\n");
    const sys="Eres un asistente m√©dico especializado en "+currentCategory+".\nResponde de forma clara, precisa y basada en evidencia m√©dica.\nResponde siempre en espa√±ol."+(docsCtx?"\n\nDocumentos disponibles:\n"+docsCtx:"");
    const resp=await llamarOllama(pregunta,sys,function(partial){
        preguntas[currentCategory][idx].respuesta=partial;
        const el=document.getElementById("resp-"+idx);if(el)el.textContent=partial;
    });
    preguntas[currentCategory][idx].respuesta=resp;
    guardarDatos();actualizarUI();
    isProcessing=false;document.getElementById("btnPreguntar").disabled=false;
}

const studioPrompts={
    resumen:{title:"üìã Resumen - ",prompt:"Genera un resumen ejecutivo completo sobre {cat}. Incluye: patolog√≠as frecuentes, m√©todos diagn√≥sticos, tratamientos est√°ndar. S√© conciso pero completo."},
    faq:{title:"‚ùì FAQ - ",prompt:"Genera 8 preguntas frecuentes sobre {cat} con respuestas. Incluye diagn√≥stico, tratamiento, urgencias, farmacolog√≠a."},
    guia:{title:"üìñ Gu√≠a - ",prompt:"Crea una gu√≠a de estudio sobre {cat}: conceptos fundamentales, clasificaciones, criterios diagn√≥sticos, f√°rmacos clave con dosis, preguntas de repaso."},
    diagnostico:{title:"ü©∫ Dx diferencial - ",prompt:"Diagn√≥stico diferencial de patolog√≠as comunes en {cat}. Para cada una: s√≠ntomas cardinales, pruebas, diagn√≥sticos diferenciales, red flags."},
    farmacologia:{title:"üíä Farmacolog√≠a - ",prompt:"Resumen farmacol√≥gico de {cat}: grupos farmacol√≥gicos, mecanismo, indicaciones, dosis, efectos adversos, contraindicaciones."},
    emergencia:{title:"üö® Emergencia - ",prompt:"Protocolos de emergencia en {cat}: reconocimiento r√°pido, medidas inmediatas paso a paso, tratamiento urgente con dosis, criterios de derivaci√≥n."}
};
let lastStudioContent="",lastStudioTitle="";

async function studioAction(tipo){
    if(!ollamaConnected||isProcessing){if(!ollamaConnected)alert("‚ö†Ô∏è Ollama no conectado");return;}
    const cfg=studioPrompts[tipo];if(!cfg)return;
    isProcessing=true;document.querySelectorAll(".studio-card").forEach(c=>c.disabled=true);
    const resultDiv=document.getElementById("studioResult"),contentDiv=document.getElementById("studioResultContent");
    lastStudioTitle=cfg.title+currentCategory;
    document.getElementById("studioResultTitle").textContent=lastStudioTitle;
    contentDiv.textContent="‚è≥ Generando con "+CONFIG.model+"...";resultDiv.style.display="block";
    const prompt=cfg.prompt.replace(/\{cat\}/g,currentCategory);
    lastStudioContent=await llamarOllama(prompt,"Eres un experto m√©dico. Responde siempre en espa√±ol. S√© preciso y basado en evidencia.",function(p){contentDiv.textContent=p;contentDiv.scrollTop=contentDiv.scrollHeight;});
    contentDiv.textContent=lastStudioContent;
    isProcessing=false;document.querySelectorAll(".studio-card").forEach(c=>c.disabled=false);
}

function guardarStudioComoNota(){
    if(!lastStudioContent)return;
    if(!notas[currentCategory])notas[currentCategory]=[];
    notas[currentCategory].push({texto:lastStudioTitle+"\n\n"+lastStudioContent,fecha:new Date().toLocaleString("es-ES")});
    guardarDatos();actualizarUI();alert("‚úÖ Guardado como nota en "+currentCategory);
}

function agregarNota(){const t=document.getElementById("noteInput").value.trim();if(!t)return;if(!notas[currentCategory])notas[currentCategory]=[];notas[currentCategory].push({texto:t,fecha:new Date().toLocaleString("es-ES")});document.getElementById("noteInput").value="";guardarDatos();actualizarUI();}
function eliminarNota(i){if(!confirm("¬øEliminar esta nota?"))return;notas[currentCategory].splice(i,1);guardarDatos();actualizarUI();}
function limpiarEditor(){document.getElementById("noteInput").value="";document.getElementById("noteInput").focus();}

function switchTab(name,btn){document.querySelectorAll(".tab-content").forEach(t=>t.classList.remove("active"));document.querySelectorAll(".tab-btn").forEach(b=>b.classList.remove("active"));document.getElementById(name).classList.add("active");if(btn)btn.classList.add("active");}
function cambiarCategoria(cat,btn){currentCategory=cat;document.querySelectorAll(".category-btn").forEach(b=>b.classList.remove("active"));if(btn)btn.classList.add("active");document.getElementById("categoryTitle").textContent=cat;const sc=document.getElementById("studioCategory");if(sc)sc.textContent=cat;switchTab("preguntas",document.querySelector(".tab-btn"));actualizarUI();}

function escapeHtml(t){if(!t)return"";return t.replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;");}

function actualizarUI(){
    const docs=documents[currentCategory]||[];
    document.getElementById("documentosList").innerHTML=docs.length===0?'<p style="color:#999;">No hay documentos en esta categor√≠a</p>':docs.map(d=>'<div class="doc-item"><div class="doc-info"><div class="doc-name">'+d.name+'</div><div class="doc-size">'+d.size_mb+' MB ‚Ä¢ '+d.type+'</div></div><a href="'+d.url+'" target="_blank" class="doc-btn">Ver</a></div>').join("");
    document.getElementById("docsCount").textContent=docs.length;
    document.getElementById("preguntasCount").textContent=(preguntas[currentCategory]||[]).length;
    document.getElementById("notasCount").textContent=(notas[currentCategory]||[]).length;
    const pArr=preguntas[currentCategory]||[],pList=document.getElementById("preguntasList");
    pList.innerHTML=pArr.length===0?'<div class="empty-state"><div class="empty-state-icon">‚ùì</div><p>Haz preguntas usando IA local</p></div>':pArr.map((p,i)=>'<div class="question-box"><div class="question-text">‚ùì '+escapeHtml(p.pregunta)+'</div><div class="answer-text" id="resp-'+i+'">'+escapeHtml(p.respuesta)+'</div><div class="note-time">'+p.fecha+'</div></div>').join("");
    const nArr=notas[currentCategory]||[],nList=document.getElementById("notasList");
    nList.innerHTML=nArr.length===0?'<div class="empty-state"><div class="empty-state-icon">üìù</div><p>Sin notas a√∫n</p></div>':nArr.map((n,i)=>'<div style="background:#f9f9f9;padding:12px;border-radius:6px;margin-bottom:8px;border-left:2px solid #0066cc;position:relative;"><div style="color:#333;font-size:0.95rem;margin-bottom:5px;white-space:pre-wrap;padding-right:30px;">'+escapeHtml(n.texto)+'</div><div style="font-size:0.8rem;color:#999;">'+n.fecha+'</div><button onclick="eliminarNota('+i+')" style="position:absolute;top:8px;right:8px;background:none;border:none;cursor:pointer;font-size:0.9rem;opacity:0.4;" title="Eliminar">üóëÔ∏è</button></div>').join("");
}

async function testConnection(){
    const url=document.getElementById("cfgUrl").value.trim();if(!url){alert("Introduce URL");return;}
    const st=document.getElementById("cfgStatus");st.innerHTML='<span style="color:#856404;">‚è≥ Probando...</span>';
    try{const h={"Content-Type":"application/json"};const k=document.getElementById("cfgApiKey").value.trim();if(k)h["X-API-Key"]=k;
        const r=await fetch(url+"/api/tags",{headers:h,signal:AbortSignal.timeout(6000)});
        if(r.ok){const d=await r.json();const m=(d.models||[]).map(x=>x.name);st.innerHTML='<span style="color:#155724;">‚úÖ Conectado! Modelos: '+m.join(", ")+"</span>";}
        else if(r.status===401)st.innerHTML='<span style="color:#721c24;">‚ùå API Key incorrecta</span>';
        else st.innerHTML='<span style="color:#721c24;">‚ùå Error '+r.status+"</span>";
    }catch(e){st.innerHTML='<span style="color:#721c24;">‚ùå '+e.message+"</span>";}
}

function guardarConfig(){CONFIG.url=document.getElementById("cfgUrl").value.trim()||"http://localhost:11434";CONFIG.model=document.getElementById("cfgModel").value;CONFIG.apiKey=document.getElementById("cfgApiKey").value.trim();saveConfigSilent();checkOllamaConnection();document.getElementById("cfgStatus").innerHTML='<span style="color:#155724;">‚úÖ Guardado</span>';}
function saveConfigSilent(){localStorage.setItem("notebook_config_v2",JSON.stringify(CONFIG));}
function resetConfig(){CONFIG={url:"http://localhost:11434",model:"qwen2.5-coder:7b",apiKey:""};saveConfigSilent();document.getElementById("cfgUrl").value=CONFIG.url;document.getElementById("cfgApiKey").value="";checkOllamaConnection();document.getElementById("cfgStatus").innerHTML='<span style="color:#155724;">‚úÖ Restaurado</span>';}

function guardarDatos(){localStorage.setItem("cartagena_preguntas",JSON.stringify(preguntas));localStorage.setItem("cartagena_notas",JSON.stringify(notas));}
function cargarDatos(){try{preguntas=JSON.parse(localStorage.getItem("cartagena_preguntas"))||{};}catch(e){preguntas={};}try{notas=JSON.parse(localStorage.getItem("cartagena_notas"))||{};}catch(e){notas={};}}

async function loadDocuments(){try{const r=await fetch("documents.json");const d=await r.json();documents=d.categories;actualizarUI();}catch(e){console.log("No documents.json:",e.message);}}

function init(){
    const p=new URLSearchParams(window.location.search),c=p.get("category");
    if(c&&categories[c])currentCategory=c;
    const list=document.getElementById("categoriesList");
    Object.keys(categories).forEach(function(cat){const btn=document.createElement("button");btn.className="category-btn"+(cat===currentCategory?" active":"");btn.innerHTML=categories[cat]+" "+cat;btn.onclick=function(){cambiarCategoria(cat,btn);};list.appendChild(btn);});
    document.getElementById("cfgUrl").value=CONFIG.url;
    document.getElementById("cfgApiKey").value=CONFIG.apiKey||"";
    document.getElementById("categoryTitle").textContent=currentCategory;
    cargarDatos();loadDocuments();checkOllamaConnection();
    setInterval(checkOllamaConnection,10000);
}

document.addEventListener("DOMContentLoaded",function(){init();document.getElementById("preguntaInput").addEventListener("keypress",function(e){if(e.key==="Enter")hacerPregunta();});});
</script>
</body>
</html>
