<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Publicador Blog â€” Cartagena Este</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link href="https://fonts.googleapis.com/css2?family=DM+Sans:wght@400;500;600;700;800&family=Playfair+Display:wght@700;800&display=swap" rel="stylesheet">
<style>
*{margin:0;padding:0;box-sizing:border-box}
:root{--bg:#f4f6f9;--card:#ffffff;--text:#1a1a2e;--sub:#6b7280;--accent:#0369a1;--accent-light:#e0f2fe;--accent-dark:#075985;--success:#059669;--success-light:#d1fae5;--error:#dc2626;--error-light:#fee2e2;--border:#e2e5ea;--shadow:0 1px 3px rgba(0,0,0,.05),0 4px 14px rgba(0,0,0,.04);--radius:16px}
html{height:100%}
body{min-height:100%;font-family:'DM Sans',sans-serif;background:var(--bg);color:var(--text);line-height:1.6;-webkit-font-smoothing:antialiased}
.header{background:linear-gradient(135deg,#0c4a6e,#075985,#0369a1);padding:24px 20px 32px;text-align:center;position:relative;overflow:hidden}
.header::before{content:'';position:absolute;inset:0;background:url("data:image/svg+xml,%3Csvg width='40' height='40' viewBox='0 0 40 40' xmlns='http://www.w3.org/2000/svg'%3E%3Cg fill='%23fff' fill-opacity='.03'%3E%3Cpath d='M20 20h-4v-4h4v4zm0-20h-4v4h4V0zM0 20h4v-4H0v4z'/%3E%3C/g%3E%3C/svg%3E")}
.hdr{position:relative;z-index:1;max-width:600px;margin:0 auto}
.hdr h1{font-family:'Playfair Display',serif;font-size:clamp(20px,4.5vw,28px);font-weight:800;color:#fff;margin-bottom:4px;letter-spacing:-.5px}
.hdr p{color:rgba(255,255,255,.75);font-size:12px;font-weight:500}
.hdr .badge{display:inline-flex;align-items:center;gap:6px;background:rgba(255,255,255,.12);padding:4px 12px;border-radius:20px;font-size:10px;color:rgba(255,255,255,.85);font-weight:700;margin-top:8px}
.hdr .badge .dot{width:6px;height:6px;border-radius:50%;background:#34d399}
.container{max-width:520px;margin:-14px auto 30px;padding:0 12px;position:relative;z-index:2}
.tabs{display:flex;background:var(--card);border-radius:14px 14px 0 0;border:1px solid var(--border);border-bottom:none;overflow:hidden}
.tab{flex:1;padding:13px 8px;text-align:center;font-size:12px;font-weight:700;color:var(--sub);cursor:pointer;transition:all .2s;border-bottom:3px solid transparent;background:transparent}
.tab:hover{color:var(--text);background:#f8f9fb}
.tab.active{color:var(--accent);border-bottom-color:var(--accent);background:#fff}
.tab .ti{font-size:16px;display:block;margin-bottom:2px}
.panel{display:none;background:var(--card);border:1px solid var(--border);border-top:none;border-radius:0 0 14px 14px;box-shadow:var(--shadow)}
.panel.active{display:block}
.pb{padding:20px 18px}

/* Login */
#loginOverlay{position:fixed;inset:0;z-index:100;background:#0c4a6e;display:flex;align-items:center;justify-content:center}
#loginOverlay.hidden{display:none}
@keyframes shake{0%,100%{transform:translateX(0)}20%,60%{transform:translateX(-6px)}40%,80%{transform:translateX(6px)}}
.lb{text-align:center;max-width:340px;width:100%;padding:20px}
.li2{width:72px;height:72px;border-radius:20px;margin:0 auto 24px;background:linear-gradient(135deg,#38bdf8,#34d399);display:flex;align-items:center;justify-content:center;font-size:32px;box-shadow:0 8px 30px rgba(56,189,248,.3)}
.lt{font-family:'Playfair Display',serif;font-size:26px;font-weight:800;color:#fff;margin-bottom:6px}
.ls{color:rgba(255,255,255,.6);font-size:12px;margin-bottom:28px}
.pl{font-size:10px;font-weight:700;color:rgba(255,255,255,.5);text-transform:uppercase;letter-spacing:2px;margin-bottom:12px;display:block}
.pr{display:flex;justify-content:center;gap:10px;margin-bottom:8px}
.pd{width:50px;height:58px;border:2px solid rgba(255,255,255,.15);background:rgba(255,255,255,.06);border-radius:12px;text-align:center;font-family:inherit;font-size:22px;font-weight:800;color:#38bdf8;outline:none;transition:all .2s;caret-color:#38bdf8}
.pd:focus{border-color:#38bdf8;box-shadow:0 0 0 3px rgba(56,189,248,.2)}
.pd.err{border-color:#f87171;animation:shake .4s ease}
.pbtn{width:100%;padding:14px;border:none;border-radius:12px;background:linear-gradient(135deg,#38bdf8,#0ea5e9);color:#0c4a6e;font-family:inherit;font-size:14px;font-weight:800;cursor:pointer;margin-top:8px;box-shadow:0 4px 16px rgba(56,189,248,.3)}
.pe{color:#f87171;font-size:11px;font-weight:600;margin-top:8px;min-height:16px}
.lf{color:rgba(255,255,255,.35);font-size:9px;margin-top:20px}

/* Form */
.field{margin-bottom:16px}
.field label{display:block;font-size:12px;font-weight:700;color:var(--text);margin-bottom:6px}
.field label .opt{font-weight:500;color:var(--sub);font-size:10px}
.field .hint{font-size:10px;color:var(--sub);margin-top:4px}
textarea,select{width:100%;padding:12px 14px;border:2px solid var(--border);border-radius:12px;font-family:inherit;font-size:14px;color:var(--text);background:#fff;outline:none;transition:border .2s,box-shadow .2s;resize:vertical;-webkit-appearance:none}
textarea:focus,select:focus{border-color:var(--accent);box-shadow:0 0 0 3px var(--accent-light)}
textarea::placeholder{color:#9ca3af}
textarea{min-height:110px;line-height:1.6}
select{cursor:pointer;padding-right:36px;background-image:url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='16' height='16' viewBox='0 0 24 24' fill='none' stroke='%236b7280' stroke-width='2'%3E%3Cpath d='M6 9l6 6 6-6'/%3E%3C/svg%3E");background-repeat:no-repeat;background-position:right 12px center}
.dropzone{border:2px dashed #d1d5db;border-radius:12px;padding:20px 16px;text-align:center;cursor:pointer;transition:all .2s;background:#fafbfc}
.dropzone:hover,.dropzone.drag{border-color:var(--accent);background:var(--accent-light)}
.dropzone .di{font-size:26px;margin-bottom:4px}
.dropzone .dt{font-size:12px;font-weight:700;color:var(--text)}
.dropzone .ds{font-size:10px;color:var(--sub)}
.dropzone input{display:none}
.fl{margin-top:8px}
.fi{display:flex;align-items:center;gap:8px;padding:8px 10px;background:#f9fafb;border:1px solid var(--border);border-radius:10px;margin-bottom:4px;animation:su .2s ease}
@keyframes su{from{opacity:0;transform:translateY(-6px)}}
.fi .ic{font-size:16px;flex-shrink:0}
.fi .inf{flex:1;min-width:0}
.fi .nm{font-size:11px;font-weight:600;overflow:hidden;text-overflow:ellipsis;white-space:nowrap}
.fi .sz{font-size:9px;color:var(--sub)}
.fi .rm{width:24px;height:24px;border-radius:6px;border:none;background:var(--error-light);color:var(--error);cursor:pointer;display:flex;align-items:center;justify-content:center;font-size:12px;flex-shrink:0}
.fi .rm:hover{background:var(--error);color:#fff}
.or{display:flex;gap:10px}
.or>div{flex:1}
.pub{width:100%;padding:14px;border:none;border-radius:12px;background:linear-gradient(135deg,var(--accent),var(--accent-dark));color:#fff;font-family:inherit;font-size:14px;font-weight:800;cursor:pointer;transition:all .2s;display:flex;align-items:center;justify-content:center;gap:8px;box-shadow:0 4px 14px rgba(3,105,161,.25);margin-top:4px}
.pub:hover{transform:translateY(-1px);box-shadow:0 6px 20px rgba(3,105,161,.35)}
.pub:disabled{opacity:.5;cursor:not-allowed;transform:none}
.pub .sp{width:16px;height:16px;border:2.5px solid rgba(255,255,255,.3);border-top-color:#fff;border-radius:50%;animation:spin .8s linear infinite}
@keyframes spin{to{transform:rotate(360deg)}}
.sa{margin-top:12px}
.lg{display:flex;align-items:flex-start;gap:6px;padding:4px 0;font-size:11px}
.lg .gi{flex-shrink:0;font-size:12px;margin-top:1px}
.lg.info{color:var(--sub)}.lg.ok{color:var(--success)}.lg.err{color:var(--error)}
.sc{background:var(--success-light);border:1px solid #a7f3d0;border-radius:14px;padding:16px;margin-top:16px}
.sc h3{font-size:14px;font-weight:800;color:var(--success);margin-bottom:4px}
.sc .pt{font-size:12px;font-weight:700;color:var(--text);margin-bottom:6px}
.sc a{color:var(--accent);font-size:11px;font-weight:600;word-break:break-all}
.sc .nb{display:inline-flex;align-items:center;gap:4px;margin-top:10px;padding:8px 16px;background:var(--accent);color:#fff;border:none;border-radius:8px;font-family:inherit;font-size:11px;font-weight:700;cursor:pointer}

/* QR */
.qw{text-align:center;padding:8px 0}
.qf{display:inline-block;padding:14px;background:#fff;border-radius:14px;box-shadow:0 4px 20px rgba(0,0,0,.08);border:1px solid var(--border);position:relative}
.qf canvas{display:block}
.qb2{position:absolute;bottom:-9px;left:50%;transform:translateX(-50%);background:var(--accent);color:#fff;font-size:8px;font-weight:800;padding:4px 12px;border-radius:16px;letter-spacing:.8px;text-transform:uppercase;white-space:nowrap}
.qs{margin-top:22px;font-size:13px;color:var(--sub);line-height:2}
.qs b{color:var(--text)}
.sn{display:inline-flex;align-items:center;justify-content:center;width:20px;height:20px;border-radius:6px;background:var(--accent-light);color:var(--accent);font-size:10px;font-weight:800;margin-right:4px}
.lbx{margin-top:18px;padding:14px;background:#f8f9fb;border:1px solid var(--border);border-radius:12px}
.lbx label{font-size:10px;font-weight:700;color:var(--sub);text-transform:uppercase;letter-spacing:1px;margin-bottom:8px;display:block}
.lr{display:flex;gap:6px}
.lu{flex:1;padding:10px 12px;background:#fff;border:1px solid var(--border);border-radius:10px;font-family:inherit;font-size:11px;font-weight:600;color:var(--accent);outline:none;overflow:hidden;text-overflow:ellipsis;white-space:nowrap}
.cb{padding:10px 16px;background:var(--accent);color:#fff;border:none;border-radius:10px;font-family:inherit;font-size:11px;font-weight:700;cursor:pointer;white-space:nowrap}
.cb:hover{background:var(--accent-dark)}
.cb.ok{background:var(--success)}
.sg{display:grid;grid-template-columns:1fr 1fr;gap:8px;margin-top:14px}
.sb{padding:12px 8px;border:1px solid var(--border);background:#fff;border-radius:12px;font-family:inherit;font-size:11px;font-weight:700;color:var(--text);cursor:pointer;transition:all .15s;text-align:center}
.sb:hover{border-color:var(--accent);background:var(--accent-light)}
.sb .si{font-size:18px;display:block;margin-bottom:3px}
.sb .sm{font-size:9px;color:var(--sub);font-weight:500}

.lo{display:flex;justify-content:flex-end;padding:8px 18px 0}
.lo button{background:none;border:none;color:var(--sub);font-size:11px;font-weight:600;cursor:pointer;font-family:inherit;padding:4px 8px;border-radius:6px}
.lo button:hover{color:var(--error);background:var(--error-light)}
.footer{text-align:center;padding:16px;font-size:9px;color:var(--sub)}
.footer a{color:var(--accent);text-decoration:none;font-weight:600}
@media(max-width:480px){.or{flex-direction:column;gap:10px}.dk-row{flex-direction:column;gap:10px}}

/* Dark Publisher */
.dk{background:#0d1520;border-radius:0 0 14px 14px;overflow:hidden}
.dk-head{display:flex;align-items:center;gap:12px;padding:16px 18px;border-bottom:1px solid #1e2d42}
.dk-icon{width:40px;height:40px;border-radius:10px;background:linear-gradient(135deg,#0ea5e9,#06b6d4);display:flex;align-items:center;justify-content:center;font-size:18px;flex-shrink:0}
.dk-title{font-size:14px;font-weight:800;color:#e2e8f0}
.dk-sub{font-size:10px;color:#64748b;margin-top:1px}
.dk-body{padding:18px}
.dk-label{display:block;font-size:10px;font-weight:700;color:#64748b;text-transform:uppercase;letter-spacing:1.5px;margin-bottom:8px}
.dk-ta{width:100%;min-height:100px;padding:14px;background:#131d2e;border:1px solid #1e2d42;border-radius:10px;color:#cbd5e1;font-family:inherit;font-size:13px;line-height:1.6;resize:vertical;outline:none;transition:border .2s}
.dk-ta:focus{border-color:#0ea5e9}
.dk-ta::placeholder{color:#475569}
.dk-drop{border:2px dashed #1e2d42;border-radius:10px;padding:18px;text-align:center;cursor:pointer;transition:all .2s;margin:14px 0 8px;background:#0a1018}
.dk-drop:hover,.dk-drop.drag{border-color:#0ea5e9;background:#0c1525}
.dk-drop-t{font-size:12px;font-weight:700;color:#94a3b8;margin-top:4px}
.dk-drop-s{font-size:10px;color:#475569}
.dk-drop input{display:none}
.dk-fi{display:flex;align-items:center;gap:8px;padding:8px 10px;background:#131d2e;border:1px solid #1e2d42;border-radius:8px;margin-bottom:4px}
.dk-fi .ic{font-size:14px;flex-shrink:0}
.dk-fi .nm{flex:1;font-size:11px;font-weight:600;color:#94a3b8;overflow:hidden;text-overflow:ellipsis;white-space:nowrap}
.dk-fi .sz{font-size:9px;color:#475569;margin-left:4px;flex-shrink:0}
.dk-fi .rm{width:22px;height:22px;border-radius:6px;border:none;background:#1e1e2e;color:#f87171;cursor:pointer;display:flex;align-items:center;justify-content:center;font-size:11px;flex-shrink:0}
.dk-fi .rm:hover{background:#f87171;color:#fff}
.dk-row{display:flex;gap:12px;margin:14px 0}
.dk-row>div{flex:1}
.dk-sel{width:100%;padding:10px 12px;background:#131d2e;border:1px solid #1e2d42;border-radius:10px;color:#94a3b8;font-family:inherit;font-size:12px;font-weight:600;outline:none;-webkit-appearance:none;cursor:pointer;background-image:url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='16' height='16' viewBox='0 0 24 24' fill='none' stroke='%2364748b' stroke-width='2'%3E%3Cpath d='M6 9l6 6 6-6'/%3E%3C/svg%3E");background-repeat:no-repeat;background-position:right 10px center}
.dk-sel:focus{border-color:#0ea5e9}
.dk-pub{width:100%;padding:14px;border:none;border-radius:10px;background:linear-gradient(135deg,#0ea5e9,#06b6d4);color:#0c1525;font-family:inherit;font-size:14px;font-weight:800;cursor:pointer;transition:all .2s;box-shadow:0 4px 16px rgba(14,165,233,.3)}
.dk-pub:hover{transform:translateY(-1px);box-shadow:0 6px 24px rgba(14,165,233,.4)}
.dk-pub:disabled{opacity:.5;cursor:not-allowed;transform:none}
.dk-pub .sp{display:inline-block;width:14px;height:14px;border:2.5px solid rgba(12,21,37,.3);border-top-color:#0c1525;border-radius:50%;animation:spin .8s linear infinite;vertical-align:middle;margin-right:6px}
.dk-log{display:flex;align-items:flex-start;gap:6px;padding:4px 0;font-size:11px;color:#64748b}
.dk-log.ok{color:#34d399}
.dk-log.err{color:#f87171}
.dk-log .gi{flex-shrink:0;margin-top:1px}
.dk-suc{background:#06291e;border:1px solid #065f46;border-radius:10px;padding:14px;margin-top:14px}
.dk-suc h3{font-size:13px;font-weight:800;color:#34d399;margin-bottom:4px}
.dk-suc .pt{font-size:12px;font-weight:700;color:#e2e8f0;margin-bottom:6px}
.dk-suc a{color:#38bdf8;font-size:11px;font-weight:600;word-break:break-all}
.dk-suc .nb{display:inline-flex;margin-top:10px;padding:8px 16px;background:#0ea5e9;color:#0c1525;border:none;border-radius:8px;font-family:inherit;font-size:11px;font-weight:700;cursor:pointer}
@media print{#loginOverlay,.tabs,.footer,.lo,#pPub{display:none!important}#pQR{display:block!important}body{background:#fff}.header{background:#fff!important}.hdr h1{color:#000!important}.hdr p,.hdr .badge{display:none}.panel{border:none;box-shadow:none}.sg,.lbx{display:none}.po{display:block!important;text-align:center;margin-top:16px;font-size:14px;font-weight:700;color:#333}}
.po{display:none}
</style>
</head>
<body>

<!-- LOGIN -->
<div id="loginOverlay">
<div class="lb">
<div class="li2">ğŸ¥</div>
<h1 class="lt">Cartagena Este</h1>
<p class="ls">Introduce el PIN para acceder al publicador</p>
<span class="pl">Pin de acceso</span>
<div class="pr">
<input class="pd" type="tel" maxlength="1" id="p0" inputmode="numeric" autofocus>
<input class="pd" type="tel" maxlength="1" id="p1" inputmode="numeric">
<input class="pd" type="tel" maxlength="1" id="p2" inputmode="numeric">
<input class="pd" type="tel" maxlength="1" id="p3" inputmode="numeric">
</div>
<div class="pe" id="pinErr"></div>
<button class="pbtn" onclick="checkPin()">Acceder</button>
<p class="lf">Centro de Salud Cartagena Este Â· Solo personal autorizado</p>
</div>
</div>

<!-- MAIN -->
<div class="header"><div class="hdr">
<h1>ğŸ“ Cartagena Este â€” Blog</h1>
<p>Publica noticias, sesiones y documentos</p>
<div class="badge"><span class="dot"></span> cartagenaeste.es</div>
</div></div>

<div class="container">
<div class="lo"><button onclick="logout()">ğŸ”’ Cerrar sesiÃ³n</button></div>

<div class="tabs">
<div class="tab active" onclick="stab('pub')"><span class="ti">âœï¸</span>Publicar</div>
<div class="tab" onclick="stab('qr')"><span class="ti">ğŸ“±</span>QR y Enlace</div>
<div class="tab" onclick="window.open('publicador-blog.html','_blank')"><span class="ti">âš¡</span>Blog Publisher</div>
</div>

<!-- PUBLISH -->
<div class="panel active" id="pPub"><div class="pb">
<div class="field">
<label>Â¿QuÃ© quieres compartir?</label>
<textarea id="content" placeholder="Escribe tu noticia, sesiÃ³n clÃ­nica, evento o aviso...&#10;&#10;Ejemplo: Hoy hemos tenido sesiÃ³n sobre manejo de colangitis aguda."></textarea>
<div class="hint">La IA generarÃ¡ tÃ­tulo, formato y etiquetas automÃ¡ticamente.</div>
</div>
<div class="field">
<label>Adjuntar archivos <span class="opt">(opcional)</span></label>
<div class="dropzone" id="dropzone">
<div class="di">ğŸ“</div>
<div class="dt">Toca para adjuntar archivos</div>
<div class="ds">Fotos, PDFs, Word, Excel, PowerPoint...</div>
<input type="file" id="fileInput" multiple accept="image/*,.pdf,.doc,.docx,.xls,.xlsx,.pptx,.ppt,.txt,.csv,.zip,.rar">
</div>
<div class="fl" id="filesList"></div>
</div>
<div class="field"><div class="or">
<div><label>CategorÃ­a</label><select id="category"><option value="">ğŸ¤– AutomÃ¡tica</option></select></div>
<div><label>Estado</label><select id="status"><option value="publish">âœ… Publicar</option><option value="draft">ğŸ“‹ Borrador</option></select></div>
</div></div>
<button class="pub" id="pubBtn" onclick="doPublish()">ğŸš€ Publicar en cartagenaeste.es</button>
<div class="sa" id="statusArea"></div>
<div id="successCard" style="display:none"></div>
</div></div>

<!-- QR -->
<div class="panel" id="pQR"><div class="pb">
<div class="qw">
<div class="qf"><canvas id="qrCanvas"></canvas><div class="qb2">cartagenaeste.es</div></div>
<div class="qs">
<span class="sn">1</span> Abre la <b>cÃ¡mara</b> del mÃ³vil<br>
<span class="sn">2</span> Apunta al <b>cÃ³digo QR</b><br>
<span class="sn">3</span> Escribe y dale a <b>Publicar</b>
</div>
</div>
<div class="lbx">
<label>ğŸ”— Enlace directo</label>
<div class="lr"><input class="lu" id="linkUrl" readonly onclick="this.select()"><button class="cb" id="copyBtn" onclick="copyLink()">Copiar</button></div>
</div>
<div class="sg">
<button class="sb" onclick="shareWA()"><span class="si">ğŸ’¬</span>WhatsApp<br><span class="sm">Compartir</span></button>
<button class="sb" onclick="shareMail()"><span class="si">âœ‰ï¸</span>Email<br><span class="sm">Enviar</span></button>
<button class="sb" onclick="window.print()"><span class="si">ğŸ–¨ï¸</span>Imprimir<br><span class="sm">Cartel QR</span></button>
<button class="sb" onclick="dlQR()"><span class="si">ğŸ’¾</span>Descargar<br><span class="sm">Imagen QR</span></button>
</div>
<div class="po">Escanea este QR para publicar en el blog<br><span style="font-size:12px;font-weight:400;color:#666" id="pUrl"></span></div>
</div></div>

<!-- DARK BLOG PUBLISHER -->
<div class="panel" id="pDark"><div class="dk">
<div class="dk-head">
<div class="dk-icon">ğŸ“°</div>
<div><div class="dk-title">Blog Publisher â€” cartagenaeste.es</div><div class="dk-sub">Escribe â†’ IA formatea â†’ Se publica automÃ¡ticamente</div></div>
</div>
<div class="dk-body">
<label class="dk-label">TU CONTENIDO</label>
<textarea id="dk-content" class="dk-ta" placeholder="Escribe lo que quieras publicar: noticia, evento, aviso del barrio...&#10;&#10;La IA generarÃ¡ tÃ­tulo, formato HTML, etiquetas y lo subirÃ¡ automÃ¡ticamente."></textarea>

<div class="dk-drop" id="dkDrop">
<div style="font-size:22px">ğŸ“</div>
<div class="dk-drop-t">Arrastra fotos o archivos aquÃ­</div>
<div class="dk-drop-s">ImÃ¡genes, PDFs, documentos...</div>
<input type="file" id="dkFileInput" multiple accept="image/*,.pdf,.doc,.docx,.xls,.xlsx,.pptx,.ppt,.txt,.csv,.zip,.rar">
</div>
<div id="dkFiles"></div>

<div class="dk-row">
<div><label class="dk-label">ESTADO</label><select id="dk-status" class="dk-sel"><option value="publish">âœ… Publicar</option><option value="draft">ğŸ“‹ Borrador</option></select></div>
<div><label class="dk-label">CATEGORÃA</label><select id="dk-cat" class="dk-sel"><option value="">ğŸ¤– AutomÃ¡tica</option></select></div>
</div>

<button class="dk-pub" id="dkPubBtn" onclick="dkPublish()">âš¡ Publicar automÃ¡ticamente</button>
<div id="dkStatus"></div>
<div id="dkSuccess" style="display:none"></div>
</div>
</div></div>
</div>

<div class="footer">Publicador de <a href="https://cartagenaeste.es" target="_blank">cartagenaeste.es</a> Â· Centro de Salud Cartagena Este</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/qrious/4.0.2/qrious.min.js"></script>
<script>
const WP={url:'https://cartagenaeste.es',key:'fh_k8x2pL9mNqR4vW7yZ3'};
const GK='gsk_sv9ihruX8Oym'+'DKX8d6RJWGdyb3FY'+'IoFSrTjLUrj6dJIanPUukjxE';
const PIN='2507';
const U=location.href.split('?')[0].split('#')[0];
let files=[];

// PIN
const ds=[...'0123'].map(i=>document.getElementById('p'+i));
ds.forEach((d,i)=>{
d.addEventListener('input',()=>{d.value=d.value.replace(/\D/g,'').slice(-1);if(d.value&&i<3)ds[i+1].focus();if(i===3&&d.value)checkPin();document.getElementById('pinErr').textContent='';ds.forEach(x=>x.classList.remove('err'))});
d.addEventListener('keydown',e=>{if(e.key==='Backspace'&&!d.value&&i>0){ds[i-1].focus();ds[i-1].value=''}if(e.key==='Enter')checkPin()});
d.addEventListener('paste',e=>{e.preventDefault();const p=(e.clipboardData.getData('text')||'').replace(/\D/g,'').slice(0,4);p.split('').forEach((c,j)=>{if(ds[j])ds[j].value=c});if(p.length>=4)checkPin();else if(ds[p.length])ds[p.length].focus()});
});
function checkPin(){const v=ds.map(d=>d.value).join('');if(v.length<4){document.getElementById('pinErr').textContent='Introduce los 4 dÃ­gitos';return}if(v===PIN){sessionStorage.setItem('ce','1');document.getElementById('loginOverlay').classList.add('hidden');initApp()}else{document.getElementById('pinErr').textContent='PIN incorrecto';ds.forEach(d=>{d.classList.add('err')});setTimeout(()=>{ds.forEach(d=>{d.value='';d.classList.remove('err')});ds[0].focus()},600)}}
function logout(){sessionStorage.removeItem('ce');document.getElementById('loginOverlay').classList.remove('hidden');ds.forEach(d=>d.value='');ds[0].focus()}

// Tabs
function stab(n){const tabs=['pub','qr','dark'];const panels=['pPub','pQR','pDark'];document.querySelectorAll('.tab').forEach((t,i)=>{t.classList.toggle('active',tabs[i]===n)});panels.forEach((p,i)=>{document.getElementById(p).classList.toggle('active',tabs[i]===n)})}

// Init
function initApp(){document.getElementById('linkUrl').value=U;document.getElementById('pUrl').textContent=U;new QRious({element:document.getElementById('qrCanvas'),value:U,size:180,level:'H',foreground:'#1a1a2e',background:'#fff',padding:8});loadCats()}
async function loadCats(){try{const r=await fetch(WP.url+'/wp-json/filehub/v1/categories',{headers:{'X-Filehub-Key':WP.key}});const c=await r.json();if(Array.isArray(c)){[document.getElementById('category'),document.getElementById('dk-cat')].forEach(s=>{c.forEach(x=>{const o=document.createElement('option');o.value=x.id;o.textContent=x.name;s.appendChild(o)})})}}catch(e){}}
if(sessionStorage.getItem('ce')){document.getElementById('loginOverlay').classList.add('hidden');initApp()}

// Files
const dz=document.getElementById('dropzone'),fi=document.getElementById('fileInput');
dz.addEventListener('click',()=>fi.click());
dz.addEventListener('dragover',e=>{e.preventDefault();dz.classList.add('drag')});
dz.addEventListener('dragleave',()=>dz.classList.remove('drag'));
dz.addEventListener('drop',e=>{e.preventDefault();dz.classList.remove('drag');addF(e.dataTransfer.files)});
fi.addEventListener('change',()=>{addF(fi.files);fi.value=''});
function addF(l){for(let i=0;i<l.length;i++)files.push(l[i]);renF()}
function rmF(i){files.splice(i,1);renF()}
function renF(){const el=document.getElementById('filesList');if(!files.length){el.innerHTML='';return}const ic={'image':'ğŸ–¼ï¸','application/pdf':'ğŸ“„','application/vnd':'ğŸ“Š','text':'ğŸ“'};el.innerHTML=files.map((f,i)=>{let icon='ğŸ“';for(const[k,v]of Object.entries(ic)){if(f.type.startsWith(k)){icon=v;break}}const s=f.size<1048576?(f.size/1024).toFixed(0)+' KB':(f.size/1048576).toFixed(1)+' MB';return`<div class="fi"><span class="ic">${icon}</span><div class="inf"><div class="nm">${f.name}</div><div class="sz">${s}</div></div><button class="rm" onclick="rmF(${i})">âœ•</button></div>`}).join('')}

// Log
function log(m,t){const ic={info:'â³',ok:'âœ…',err:'âŒ'};document.getElementById('statusArea').innerHTML+=`<div class="lg ${t||'info'}"><span class="gi">${ic[t]||'â³'}</span><span>${m}</span></div>`}

// API
async function api(ep,o){const url=WP.url+'/wp-json/filehub/v1/'+ep;const opts=Object.assign({},o||{});if(!opts.headers)opts.headers={};opts.headers['X-Filehub-Key']=WP.key;const r=await fetch(url,opts);const d=await r.json();if(!r.ok)throw new Error(d?.error||'Error '+r.status);return d}
async function upF(f){const fd=new FormData();fd.append('file',f);const r=await fetch(WP.url+'/wp-json/filehub/v1/upload',{method:'POST',headers:{'X-Filehub-Key':WP.key},body:fd});const d=await r.json();if(!r.ok)throw new Error(d?.error||'Error');return d}
async function aiGen(txt,imgs,docs){let c='';if(imgs.length)c+='\n\nImÃ¡genes:\n'+imgs.map((u,i)=>(i+1)+'. '+u).join('\n')+'\nInsÃ©rtalas con <img src="URL" alt="foto" style="max-width:100%;height:auto;border-radius:8px;margin:16px 0">.';if(docs.length)c+='\n\nDocumentos adjuntos:\n'+docs.map(d=>'- '+d.name+': '+d.url).join('\n');const r=await fetch('https://api.groq.com/openai/v1/chat/completions',{method:'POST',headers:{'Authorization':'Bearer '+GK,'Content-Type':'application/json'},body:JSON.stringify({model:'llama-3.3-70b-versatile',max_tokens:4000,temperature:.7,messages:[{role:'system',content:'Editor blog cartagenaeste.es (centro salud zona este Cartagena, Murcia). Responde SOLO JSON sin backticks: {"title":"titulo SEO","content":"<p>HTML profesional</p>","excerpt":"resumen","tags":["tag1"],"category_suggestion":"cat"}. Si hay documentos incluye al final: <div style="background:#f0f9ff;padding:16px;border-radius:12px;margin-top:24px"><h3>ğŸ“ Documentos adjuntos</h3><ul><li><a href="URL" target="_blank" style="color:#0369a1;font-weight:600">NOMBRE</a></li></ul></div>. Tono cercano, profesional, sanitario.'},{role:'user',content:'Genera entrada completa:\n\n'+txt+c}]})});if(!r.ok)throw new Error('Error IA');const d=await r.json();const t=(d.choices?.[0]?.message?.content||'').replace(/```json?\n?/g,'').replace(/```/g,'').trim();const m=t.match(/\{[\s\S]*\}/);if(!m)throw new Error('IA no generÃ³ formato correcto');return JSON.parse(m[0])}

// Publish
async function doPublish(){const content=document.getElementById('content').value.trim();const st=document.getElementById('status').value;const catId=document.getElementById('category').value;if(!content&&!files.length){alert('Escribe algo o adjunta un archivo');return}const btn=document.getElementById('pubBtn');btn.disabled=true;btn.innerHTML='<div class="sp"></div> Publicando...';document.getElementById('statusArea').innerHTML='';document.getElementById('successCard').style.display='none';try{let media=[];if(files.length){log('Subiendo '+files.length+' archivo(s)...','info');for(const f of files){try{const m=await upF(f);media.push(m);log(f.name+' âœ“','ok')}catch(e){log(f.name+': '+e.message,'err')}}}const imgs=media.filter(m=>m.mime_type?.startsWith('image/')).map(m=>m.source_url);const docs=media.filter(m=>!m.mime_type?.startsWith('image/')).map(m=>({name:m.title||m.source_url.split('/').pop(),url:m.source_url}));log('Generando con IA...','info');const post=await aiGen(content||'PublicaciÃ³n con archivos',imgs,docs);log('TÃ­tulo: "'+post.title+'"','ok');let tagIds=[];if(post.tags?.length)for(const n of post.tags){try{const t=await api('tag',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({name:n})});if(t?.id)tagIds.push(t.id)}catch{}}let catIds=[];if(catId)catIds=[parseInt(catId)];else if(post.category_suggestion){const sel=document.getElementById('category');for(let i=0;i<sel.options.length;i++){if(sel.options[i].textContent.toLowerCase().includes(post.category_suggestion.toLowerCase())){catIds=[parseInt(sel.options[i].value)];break}}}log('Publicando...','info');const wp={title:post.title,content:post.content,excerpt:post.excerpt||'',status:st};if(tagIds.length)wp.tags=tagIds;if(catIds.length)wp.categories=catIds;const img1=media.find(m=>m.mime_type?.startsWith('image/'));if(img1)wp.featured_media=img1.id;const res=await api('publish',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify(wp)});log('Â¡'+(st==='publish'?'Publicado':'Borrador guardado')+'!','ok');const sc=document.getElementById('successCard');sc.innerHTML='<div class="sc"><h3>ğŸ‰ Â¡'+(st==='publish'?'Publicado':'Borrador guardado')+'!</h3><div class="pt">'+post.title+'</div><a href="'+res.link+'" target="_blank">ğŸ”— Ver en cartagenaeste.es</a><br><button class="nb" onclick="resetForm()">âœï¸ Nueva publicaciÃ³n</button></div>';sc.style.display='block';sc.scrollIntoView({behavior:'smooth',block:'center'})}catch(e){log('Error: '+e.message,'err')}finally{btn.disabled=false;btn.innerHTML='ğŸš€ Publicar en cartagenaeste.es'}}
function resetForm(){document.getElementById('content').value='';files=[];renF();document.getElementById('statusArea').innerHTML='';document.getElementById('successCard').style.display='none';window.scrollTo({top:0,behavior:'smooth'})}

// QR share
function copyLink(){navigator.clipboard.writeText(U).then(()=>{const b=document.getElementById('copyBtn');b.textContent='âœ…';b.classList.add('ok');setTimeout(()=>{b.textContent='Copiar';b.classList.remove('ok')},2000)})}
function shareWA(){window.open('https://wa.me/?text='+encodeURIComponent('ğŸ“ *Blog Cartagena Este*\n\nPublica en el blog del centro:\nğŸ‘‰ '+U+'\n\nPIN: '+PIN),'_blank')}
function shareMail(){window.open('mailto:?subject='+encodeURIComponent('Publicador blog Cartagena Este')+'&body='+encodeURIComponent('Enlace al publicador:\n'+U+'\n\nPIN: '+PIN))}
function dlQR(){const c=document.getElementById('qrCanvas');const o=document.createElement('canvas');o.width=400;o.height=460;const x=o.getContext('2d');x.fillStyle='#fff';x.fillRect(0,0,400,460);x.drawImage(c,30,16,340,340);x.fillStyle='#1a1a2e';x.font='bold 16px sans-serif';x.textAlign='center';x.fillText('Blog Cartagena Este',200,390);x.font='14px sans-serif';x.fillStyle='#666';x.fillText('PIN: '+PIN,200,415);x.fillText(U.replace('https://',''),200,440);const a=document.createElement('a');a.download='QR-Blog-CartagenaEste.png';a.href=o.toDataURL('image/png');a.click()}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// DARK PUBLISHER
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
let dkFiles=[];
const dkDz=document.getElementById('dkDrop'),dkFi=document.getElementById('dkFileInput');
dkDz.addEventListener('click',()=>dkFi.click());
dkDz.addEventListener('dragover',e=>{e.preventDefault();dkDz.classList.add('drag')});
dkDz.addEventListener('dragleave',()=>dkDz.classList.remove('drag'));
dkDz.addEventListener('drop',e=>{e.preventDefault();dkDz.classList.remove('drag');dkAddF(e.dataTransfer.files)});
dkFi.addEventListener('change',()=>{dkAddF(dkFi.files);dkFi.value=''});

function dkAddF(l){for(let i=0;i<l.length;i++)dkFiles.push(l[i]);dkRenF()}
function dkRmF(i){dkFiles.splice(i,1);dkRenF()}
function dkRenF(){const el=document.getElementById('dkFiles');if(!dkFiles.length){el.innerHTML='';return}const ic={'image':'ğŸ–¼ï¸','application/pdf':'ğŸ“„','application/vnd':'ğŸ“Š','text':'ğŸ“'};el.innerHTML=dkFiles.map((f,i)=>{let icon='ğŸ“';for(const[k,v]of Object.entries(ic)){if(f.type.startsWith(k)){icon=v;break}}const s=f.size<1048576?(f.size/1024).toFixed(0)+' KB':(f.size/1048576).toFixed(1)+' MB';return`<div class="dk-fi"><span class="ic">${icon}</span><span class="nm">${f.name}</span><span class="sz">${s}</span><button class="rm" onclick="dkRmF(${i})">âœ•</button></div>`}).join('')}

function dkLog(m,t){const ic={info:'â³',ok:'âœ…',err:'âŒ'};document.getElementById('dkStatus').innerHTML+=`<div class="dk-log ${t||''}""><span class="gi">${ic[t]||'â³'}</span> ${m}</div>`}

async function dkPublish(){
  const content=document.getElementById('dk-content').value.trim();
  const st=document.getElementById('dk-status').value;
  const catId=document.getElementById('dk-cat').value;
  if(!content&&!dkFiles.length){alert('Escribe algo o adjunta un archivo');return}
  const btn=document.getElementById('dkPubBtn');btn.disabled=true;btn.innerHTML='<span class="sp"></span> Publicando...';
  document.getElementById('dkStatus').innerHTML='';document.getElementById('dkSuccess').style.display='none';
  try{
    let media=[];
    if(dkFiles.length){dkLog('Subiendo '+dkFiles.length+' archivo(s)...','info');for(const f of dkFiles){try{const m=await upF(f);media.push(m);dkLog(f.name+' â†’ ID:'+m.id,'ok')}catch(e){dkLog(f.name+': '+e.message,'err')}}}
    const imgs=media.filter(m=>m.mime_type?.startsWith('image/')).map(m=>m.source_url);
    const docs=media.filter(m=>!m.mime_type?.startsWith('image/')).map(m=>({name:m.title||m.source_url.split('/').pop(),url:m.source_url}));
    dkLog('Generando con IA...','info');
    const post=await aiGen(content||'PublicaciÃ³n con archivos',imgs,docs);
    dkLog('TÃ­tulo: "'+post.title+'"','ok');
    let tagIds=[];if(post.tags?.length)for(const n of post.tags){try{const t=await api('tag',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({name:n})});if(t?.id)tagIds.push(t.id)}catch{}}
    let catIds=[];if(catId)catIds=[parseInt(catId)];else if(post.category_suggestion){const sel=document.getElementById('dk-cat');for(let i=0;i<sel.options.length;i++){if(sel.options[i].textContent.toLowerCase().includes(post.category_suggestion.toLowerCase())){catIds=[parseInt(sel.options[i].value)];break}}}
    dkLog('Publicando ('+st+')...','info');
    const wp={title:post.title,content:post.content,excerpt:post.excerpt||'',status:st};if(tagIds.length)wp.tags=tagIds;if(catIds.length)wp.categories=catIds;const img1=media.find(m=>m.mime_type?.startsWith('image/'));if(img1)wp.featured_media=img1.id;
    const res=await api('publish',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify(wp)});
    dkLog('Â¡PUBLICADO! â†’ '+res.link,'ok');
    const sc=document.getElementById('dkSuccess');
    sc.innerHTML='<div class="dk-suc"><h3>âœ… Â¡Publicado!</h3><div class="pt">'+post.title+'</div><a href="'+res.link+'" target="_blank">ğŸ”— '+res.link+'</a><br><button class="nb" onclick="dkReset()">âœï¸ Nueva publicaciÃ³n</button></div>';
    sc.style.display='block';sc.scrollIntoView({behavior:'smooth',block:'center'});
  }catch(e){dkLog('Error: '+e.message,'err')}
  finally{btn.disabled=false;btn.innerHTML='âš¡ Publicar automÃ¡ticamente'}
}
function dkReset(){document.getElementById('dk-content').value='';dkFiles=[];dkRenF();document.getElementById('dkStatus').innerHTML='';document.getElementById('dkSuccess').style.display='none';window.scrollTo({top:0,behavior:'smooth'})}
</script>
</body>
</html>
