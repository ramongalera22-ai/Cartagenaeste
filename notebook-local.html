<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cuaderno AI ¬∑ Centro de Salud Cartagena Este</title>
    <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@400;600;700&family=Source+Sans+3:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        :root{--primary:#1a6b4a;--primary-light:#238c62;--primary-dark:#0f4a33;--accent:#d4a853;--bg-dark:#1a1f2e;--bg-card:#fff;--bg-main:#f4f6f8;--bg-subtle:#e9edf2;--text:#2d3748;--text-light:#64748b;--text-muted:#94a3b8;--border:#e2e8f0;--border-light:#f1f5f9;--shadow-sm:0 1px 3px rgba(0,0,0,.06);--shadow-md:0 4px 12px rgba(0,0,0,.08);--radius:12px;--radius-sm:8px;--font-display:'Playfair Display',Georgia,serif;--font-body:'Source Sans 3',-apple-system,sans-serif}
        *{margin:0;padding:0;box-sizing:border-box}
        body{font-family:var(--font-body);background:var(--bg-main);color:var(--text);height:100vh;overflow:hidden}
        .app-layout{display:grid;grid-template-columns:280px 1fr 300px;grid-template-rows:auto 1fr;height:100vh}
        .top-nav{grid-column:1/-1;background:var(--bg-dark);color:#fff;display:flex;align-items:center;justify-content:space-between;padding:0 28px;height:56px;box-shadow:0 2px 20px rgba(0,0,0,.3);z-index:100}
        .top-nav-brand{display:flex;align-items:center;gap:12px}
        .logo-icon{width:32px;height:32px;background:linear-gradient(135deg,var(--primary),var(--primary-light));border-radius:8px;display:flex;align-items:center;justify-content:center;font-size:1rem}
        .top-nav-brand h1{font-family:var(--font-display);font-size:1.1rem;font-weight:600}
        .top-nav-brand h1 span{color:var(--accent)}
        .top-nav-links{display:flex;gap:6px;align-items:center}
        .top-nav-links a{color:rgba(255,255,255,.7);text-decoration:none;font-size:.82rem;font-weight:500;padding:6px 14px;border-radius:6px;transition:.2s}
        .top-nav-links a:hover{color:#fff;background:rgba(255,255,255,.08)}
        .nav-status{padding:5px 14px;border-radius:20px;font-size:.78rem;font-weight:600}
        .nav-status.ok{background:rgba(34,197,94,.15);color:#4ade80}
        .nav-status.err{background:rgba(239,68,68,.15);color:#f87171}
        .nav-status.wait{background:rgba(234,179,8,.15);color:#fbbf24}
        .sidebar-left{background:var(--bg-card);border-right:1px solid var(--border);display:flex;flex-direction:column;overflow:hidden}
        .sidebar-hero{padding:24px 22px 20px;background:linear-gradient(135deg,var(--bg-dark),#243347);color:#fff;position:relative;overflow:hidden}
        .sidebar-hero::before{content:'';position:absolute;top:-30px;right:-30px;width:100px;height:100px;background:var(--primary);opacity:.15;border-radius:50%}
        .sidebar-hero h2{font-family:var(--font-display);font-size:1.15rem;font-weight:600;margin-bottom:4px}
        .sidebar-hero p{font-size:.78rem;opacity:.7;font-weight:300}
        .categories-list{flex:1;overflow-y:auto;padding:8px 0}
        .category-btn{display:flex;align-items:center;gap:10px;width:100%;padding:12px 22px;text-align:left;border:none;background:0 0;cursor:pointer;font-size:.88rem;color:var(--text);font-family:var(--font-body);transition:.2s;border-left:3px solid transparent}
        .category-btn:hover{background:var(--border-light);border-left-color:var(--primary-light)}
        .category-btn.active{background:linear-gradient(90deg,rgba(26,107,74,.06),transparent);border-left-color:var(--primary);color:var(--primary);font-weight:600}
        .cat-emoji{font-size:1.05rem;width:24px;text-align:center}
        .main-content{display:flex;flex-direction:column;background:var(--bg-main);overflow:hidden}
        .content-header{padding:20px 28px;background:var(--bg-card);border-bottom:1px solid var(--border);display:flex;justify-content:space-between;align-items:center}
        .content-header h3{font-family:var(--font-display);font-size:1.5rem;font-weight:700;color:var(--primary-dark)}
        .content-area{flex:1;overflow-y:auto;padding:24px 28px}
        .tab-buttons{display:flex;gap:2px;margin-bottom:24px;background:var(--bg-card);border-radius:var(--radius);padding:4px;box-shadow:var(--shadow-sm);border:1px solid var(--border)}
        .tab-btn{flex:1;padding:10px 12px;border:none;background:0 0;cursor:pointer;color:var(--text-light);font-weight:500;font-size:.84rem;border-radius:var(--radius-sm);transition:.2s;font-family:var(--font-body);white-space:nowrap}
        .tab-btn.active{background:var(--primary);color:#fff;box-shadow:0 2px 8px rgba(26,107,74,.25)}
        .tab-btn:hover:not(.active){background:var(--bg-subtle);color:var(--text)}
        .tab-content{display:none}.tab-content.active{display:block;animation:fadeUp .3s ease}
        @keyframes fadeUp{from{opacity:0;transform:translateY(8px)}to{opacity:1;transform:translateY(0)}}
        .question-input{display:flex;gap:10px;margin-bottom:20px}
        .question-input input{flex:1;padding:13px 18px;border:2px solid var(--border);border-radius:var(--radius);font-size:.92rem;font-family:var(--font-body);background:var(--bg-card);transition:.2s}
        .question-input input:focus{outline:none;border-color:var(--primary);box-shadow:0 0 0 4px rgba(26,107,74,.1)}
        .btn{padding:11px 22px;border:none;border-radius:var(--radius-sm);cursor:pointer;font-weight:600;font-size:.88rem;transition:.2s;font-family:var(--font-body)}
        .btn-primary{background:linear-gradient(135deg,var(--primary),var(--primary-light));color:#fff}
        .btn-primary:hover:not(:disabled){box-shadow:0 4px 16px rgba(26,107,74,.35);transform:translateY(-1px)}
        .btn-primary:disabled{opacity:.5;cursor:not-allowed;transform:none;box-shadow:none}
        .btn-secondary{background:var(--bg-subtle);color:var(--text)}.btn-secondary:hover{background:var(--border)}
        .btn-small{padding:8px 16px;font-size:.82rem}
        .question-box{background:var(--bg-card);padding:18px 20px;border-radius:var(--radius);margin-bottom:14px;border-left:4px solid var(--primary);box-shadow:var(--shadow-sm);animation:fadeUp .3s;transition:box-shadow .2s;position:relative}
        .question-box:hover{box-shadow:var(--shadow-md)}
        .question-text{font-family:var(--font-display);color:var(--primary-dark);font-weight:600;margin-bottom:10px;font-size:1rem}
        .answer-text{color:var(--text);line-height:1.7;font-size:.92rem;white-space:pre-wrap;word-wrap:break-word;font-weight:300}
        .note-time{font-size:.76rem;color:var(--text-muted);margin-top:10px;font-weight:500}
        .doc-item{background:var(--bg-card);padding:14px 18px;border-radius:var(--radius-sm);margin-bottom:8px;border:1px solid var(--border);display:flex;justify-content:space-between;align-items:center;transition:.2s}
        .doc-item:hover{border-color:var(--primary-light);box-shadow:var(--shadow-sm)}
        .doc-name{font-weight:600;color:var(--text);font-size:.88rem;margin-bottom:2px}.doc-size{font-size:.78rem;color:var(--text-muted)}
        .doc-btn{background:linear-gradient(135deg,var(--primary),var(--primary-light));color:#fff;padding:7px 16px;border:none;border-radius:6px;cursor:pointer;font-size:.82rem;text-decoration:none;font-weight:600;transition:.2s}
        .doc-btn:hover{box-shadow:0 3px 10px rgba(26,107,74,.3)}
        .empty-state{text-align:center;padding:48px 24px;color:var(--text-muted)}.empty-state-icon{font-size:2.8rem;margin-bottom:12px;opacity:.6}.empty-state p{font-size:.92rem;font-weight:300}
        .studio-intro{background:linear-gradient(135deg,var(--bg-dark),#243347);border-radius:var(--radius);padding:22px 24px;margin-bottom:20px;color:#fff;position:relative;overflow:hidden}
        .studio-intro::after{content:'‚ú®';position:absolute;right:20px;top:50%;transform:translateY(-50%);font-size:2.5rem;opacity:.15}
        .studio-intro h4{font-family:var(--font-display);font-size:1.15rem;margin-bottom:6px}
        .studio-intro p{font-size:.86rem;opacity:.8;font-weight:300;line-height:1.5}
        .studio-grid{display:grid;grid-template-columns:1fr 1fr;gap:12px;margin-bottom:20px}
        .studio-card{background:var(--bg-card);border:1px solid var(--border);border-radius:var(--radius);padding:18px;cursor:pointer;transition:.25s;text-align:left;font-family:var(--font-body);position:relative;overflow:hidden}
        .studio-card::before{content:'';position:absolute;top:0;left:0;right:0;height:3px;background:linear-gradient(90deg,var(--primary),var(--accent));transform:scaleX(0);transform-origin:left;transition:transform .3s}
        .studio-card:hover:not(:disabled)::before{transform:scaleX(1)}
        .studio-card:hover:not(:disabled){border-color:var(--primary-light);box-shadow:var(--shadow-md);transform:translateY(-2px)}
        .studio-card:disabled{opacity:.4;cursor:not-allowed}
        .studio-card-icon{font-size:1.5rem;margin-bottom:8px}.studio-card-title{font-weight:600;font-size:.9rem;color:var(--text);margin-bottom:3px}.studio-card-desc{font-size:.78rem;color:var(--text-muted);font-weight:300}
        .config-box{background:var(--bg-card);border:1px solid var(--border);border-radius:var(--radius);padding:22px;margin-bottom:16px}
        .config-box h4{font-family:var(--font-display);color:var(--primary-dark);margin-bottom:12px;font-size:1rem}
        .config-row{display:flex;gap:8px;margin-bottom:10px;align-items:center}
        .config-row input,.config-row select{flex:1;padding:10px 14px;border:2px solid var(--border);border-radius:var(--radius-sm);font-size:.86rem;font-family:var(--font-body);background:var(--bg-main);transition:border-color .2s}
        .config-row input:focus,.config-row select:focus{outline:none;border-color:var(--primary)}
        .config-hint{font-size:.8rem;color:var(--text-light);margin-top:4px;line-height:1.6}
        .config-hint a{color:var(--primary);font-weight:600}
        .sidebar-right{background:var(--bg-card);border-left:1px solid var(--border);padding:24px 20px;overflow-y:auto}
        .sidebar-section-title{font-family:var(--font-display);font-weight:600;margin:0 0 14px;color:var(--primary-dark);font-size:1rem}
        .stat-card{background:var(--bg-main);padding:14px 16px;border-radius:var(--radius-sm);margin-bottom:8px;border:1px solid var(--border-light)}
        .stat-label{font-size:.76rem;color:var(--text-muted);margin-bottom:4px;text-transform:uppercase;letter-spacing:.05em;font-weight:600}
        .stat-value{font-family:var(--font-display);font-size:1.6rem;font-weight:700;color:var(--primary)}
        .model-badge{display:inline-block;background:linear-gradient(135deg,rgba(26,107,74,.08),rgba(26,107,74,.04));color:var(--primary);padding:4px 12px;border-radius:20px;font-size:.76rem;font-weight:600;font-family:Consolas,monospace;border:1px solid rgba(26,107,74,.15)}
        .info-box{background:linear-gradient(135deg,var(--bg-dark),#243347);padding:18px;border-radius:var(--radius);font-size:.84rem;line-height:1.6;color:rgba(255,255,255,.85)}
        .info-box strong{color:#fff}
        .scrollbar::-webkit-scrollbar{width:6px}.scrollbar::-webkit-scrollbar-track{background:0 0}.scrollbar::-webkit-scrollbar-thumb{background:var(--border);border-radius:3px}
        .sidebar-footer{padding:14px 22px;border-top:1px solid var(--border);font-size:.72rem;color:var(--text-muted);text-align:center}
        .sidebar-footer a{color:var(--primary);text-decoration:none}
        @media(max-width:1024px){.app-layout{grid-template-columns:1fr}.sidebar-left,.sidebar-right{display:none}.top-nav-links{display:none}}
    </style>
</head>
<body>
<div class="app-layout">
    <nav class="top-nav"><div class="top-nav-brand"><div class="logo-icon">üè•</div><h1>Centro de Salud <span>Cartagena Este</span></h1></div><div class="top-nav-links"><a href="https://cartagenaeste.es/" target="_blank">Web Principal</a><a href="https://cartagenaeste.es/home/blog-categorias/" target="_blank">Blog</a><a href="https://cartagenaeste.es/pacientes/" target="_blank">Pacientes</a><span id="statusBadge" class="nav-status wait">‚öôÔ∏è Configura API Key</span></div></nav>
    <div class="sidebar-left"><div class="sidebar-hero"><h2>Especialidades</h2><p>Cuaderno AI ¬∑ Docencia Cl√≠nica</p></div><div class="categories-list scrollbar" id="categoriesList"></div><div class="sidebar-footer">¬© 2026 <a href="https://cartagenaeste.es" target="_blank">cartagenaeste.es</a></div></div>
    <div class="main-content"><div class="content-header"><h3 id="categoryTitle">Cardiolog√≠a</h3></div>
        <div class="content-area scrollbar">
            <div class="tab-buttons"><button class="tab-btn active" onclick="switchTab('preguntas',this)">ü§ñ Preguntas IA</button><button class="tab-btn" onclick="switchTab('documentos',this)">üìö Documentos</button><button class="tab-btn" onclick="switchTab('notas',this)">üìù Notas</button><button class="tab-btn" onclick="switchTab('studio',this)">‚ú® Studio</button><button class="tab-btn" onclick="switchTab('config',this)">‚öôÔ∏è Config</button></div>
            <div id="preguntas" class="tab-content active"><div class="question-input"><input type="text" id="preguntaInput" placeholder="Haz una pregunta cl√≠nica..." spellcheck="false"><button class="btn btn-primary" onclick="hacerPregunta()" id="btnPreguntar">Preguntar</button></div><div id="preguntasList"><div class="empty-state"><div class="empty-state-icon">ü©∫</div><p>Haz tu primera pregunta cl√≠nica</p></div></div></div>
            <div id="documentos" class="tab-content"><div id="documentosList" style="margin-top:8px"></div></div>
            <div id="notas" class="tab-content"><div style="margin-bottom:20px"><textarea id="noteInput" placeholder="Escribe tus notas cl√≠nicas..." style="width:100%;padding:14px;border:2px solid var(--border);border-radius:var(--radius);min-height:90px;font-family:var(--font-body);resize:vertical;font-size:.92rem;background:var(--bg-card)" onfocus="this.style.borderColor='var(--primary)'" onblur="this.style.borderColor='var(--border)'"></textarea><div style="margin-top:10px;display:flex;gap:10px"><button class="btn btn-primary btn-small" onclick="agregarNota()">‚úì Guardar</button><button class="btn btn-secondary btn-small" onclick="document.getElementById('noteInput').value=''">Limpiar</button></div></div><div id="notasList"></div></div>
            <div id="studio" class="tab-content"><div class="studio-intro"><h4>AI Studio ¬∑ Generador Cl√≠nico</h4><p>Genera contenido m√©dico sobre <strong id="studioCategory">Cardiolog√≠a</strong> con IA.</p></div><div class="studio-grid"><button class="studio-card" onclick="studioAction('resumen')"><div class="studio-card-icon">üìã</div><div class="studio-card-title">Resumen ejecutivo</div><div class="studio-card-desc">Puntos clave</div></button><button class="studio-card" onclick="studioAction('faq')"><div class="studio-card-icon">‚ùì</div><div class="studio-card-title">FAQ Cl√≠nico</div><div class="studio-card-desc">Preguntas frecuentes</div></button><button class="studio-card" onclick="studioAction('guia')"><div class="studio-card-icon">üìñ</div><div class="studio-card-title">Gu√≠a de estudio</div><div class="studio-card-desc">Conceptos y repaso</div></button><button class="studio-card" onclick="studioAction('diagnostico')"><div class="studio-card-icon">ü©∫</div><div class="studio-card-title">Diagn√≥stico diferencial</div><div class="studio-card-desc">Patolog√≠as principales</div></button><button class="studio-card" onclick="studioAction('farmacologia')"><div class="studio-card-icon">üíä</div><div class="studio-card-title">Farmacolog√≠a</div><div class="studio-card-desc">F√°rmacos y dosis</div></button><button class="studio-card" onclick="studioAction('emergencia')"><div class="studio-card-icon">üö®</div><div class="studio-card-title">Protocolo emergencia</div><div class="studio-card-desc">Actuaci√≥n urgente</div></button></div><div id="studioResult" style="display:none"><div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:10px"><h4 style="font-family:var(--font-display);color:var(--primary-dark)" id="studioResultTitle"></h4><button class="btn btn-primary btn-small" onclick="guardarStudioComoNota()">üíæ Guardar como nota</button></div><div id="studioResultContent" class="scrollbar" style="background:var(--bg-card);border:1px solid var(--border);border-radius:var(--radius);padding:20px;line-height:1.7;font-size:.92rem;white-space:pre-wrap;max-height:400px;overflow-y:auto;font-weight:300"></div></div></div>
            <div id="config" class="tab-content"><div class="config-box"><h4>Proveedor de IA</h4><div class="config-row"><select id="cfgProvider" onchange="cambiarProvider()"><option value="groq">Groq (recomendado ¬∑ ultra r√°pido)</option><option value="qwen">Qwen API directa (Alibaba Cloud)</option></select></div>
                <div id="groqConfig"><p class="config-hint" style="margin-bottom:10px"><strong>Groq</strong> ‚Äî Gratis, ultra r√°pido, incluye Qwen3-32B<br>1. Ve a <a href="https://console.groq.com" target="_blank">console.groq.com</a><br>2. Crea cuenta gratis (sin tarjeta)<br>3. API Keys ‚Üí Create API Key<br>4. Pega la key aqu√≠ (empieza por <code>gsk_</code>)</p><div class="config-row"><input type="password" id="cfgGroqKey" placeholder="gsk_xxxxxxxxxxxx"></div><h4 style="margin-top:12px">Modelo</h4><div class="config-row"><select id="cfgGroqModel"><option value="qwen/qwen3-32b">Qwen3 32B (recomendado)</option><option value="llama-3.3-70b-versatile">Llama 3.3 70B</option><option value="deepseek-r1-distill-llama-70b">DeepSeek R1 70B</option><option value="gemma2-9b-it">Gemma 2 9B</option></select></div></div>
                <div id="qwenConfig" style="display:none"><p class="config-hint" style="margin-bottom:10px"><strong>Qwen API</strong> ‚Äî API oficial de Alibaba Cloud<br>1. Ve a <a href="https://www.alibabacloud.com/help/en/model-studio/get-api-key" target="_blank">Alibaba Cloud Model Studio</a><br>2. Crea cuenta y activa Model Studio<br>3. Crea API Key (empieza por <code>sk-</code>)<br>4. Pega la key aqu√≠</p><div class="config-row"><input type="password" id="cfgQwenKey" placeholder="sk-xxxxxxxxxxxx"></div><h4 style="margin-top:12px">Modelo</h4><div class="config-row"><select id="cfgQwenModel"><option value="qwen-turbo">Qwen Turbo (r√°pido, gratis)</option><option value="qwen-plus">Qwen Plus (mejor)</option><option value="qwen3-32b">Qwen3 32B</option><option value="qwen-max">Qwen Max (el mejor)</option></select></div></div>
                <div style="margin-top:16px;display:flex;gap:8px"><button class="btn btn-primary btn-small" onclick="guardarConfig()">üíæ Guardar</button><button class="btn btn-secondary btn-small" onclick="testApiKey()">üß™ Probar conexi√≥n</button></div><div id="cfgStatus" style="margin-top:12px"></div></div></div>
        </div>
    </div>
    <div class="sidebar-right scrollbar"><div class="sidebar-section-title">Estad√≠sticas</div><div class="stat-card"><div class="stat-label">Documentos</div><div class="stat-value" id="docsCount">0</div></div><div class="stat-card"><div class="stat-label">Preguntas</div><div class="stat-value" id="preguntasCount">0</div></div><div class="stat-card"><div class="stat-label">Notas</div><div class="stat-value" id="notasCount">0</div></div><div style="margin-top:18px"><div class="sidebar-section-title">Modelo Activo</div><div class="stat-card"><span class="model-badge" id="modelBadge">--</span><div style="font-size:.78rem;color:var(--text-muted);margin-top:8px" id="modelInfo">Configura API Key</div></div></div><div class="info-box" style="margin-top:18px"><strong>üè• Cuaderno AI</strong><br>Herramienta de docencia cl√≠nica con IA para el Centro de Salud Cartagena Este.<br><br>‚Ä¢ IA gratuita en la nube<br>‚Ä¢ Generaci√≥n de res√∫menes<br>‚Ä¢ Estudio por especialidades<br>‚Ä¢ Gu√≠as y protocolos</div></div>
</div>
<script>
var categories={"Cardiolog√≠a":"‚ù§Ô∏è","Dermatolog√≠a":"ü©π","Digestivo":"ü´Å","Endocrinolog√≠a":"üß¨","Geriatr√≠a":"üë¥","Ginecolog√≠a":"ü§∞","Neurolog√≠a":"üß†","Neumolog√≠a":"üí®","Pediatr√≠a":"üë∂","Traumatolog√≠a":"ü¶¥","Protocolos M√©dicos":"üìã"};
var currentCategory="Cardiolog√≠a",documents={},preguntas={},notas={},isProcessing=false;
var CONFIG={provider:"groq",groqKey:"",groqModel:"qwen/qwen3-32b",qwenKey:"",qwenModel:"qwen-turbo"};
try{var s=localStorage.getItem("notebook_ai_cfg_v3");if(s)Object.assign(CONFIG,JSON.parse(s));}catch(e){}

var ENDPOINTS={
    groq:{url:"https://api.groq.com/openai/v1/chat/completions",getKey:function(){return CONFIG.groqKey},getModel:function(){return CONFIG.groqModel},prefix:"gsk_"},
    qwen:{url:"https://dashscope-intl.aliyuncs.com/compatible-mode/v1/chat/completions",getKey:function(){return CONFIG.qwenKey},getModel:function(){return CONFIG.qwenModel},prefix:"sk-"}
};
function ep(){return ENDPOINTS[CONFIG.provider]||ENDPOINTS.groq}
function isReady(){var e=ep();var k=e.getKey();return k&&k.startsWith(e.prefix)}
function updateStatus(){
    var el=document.getElementById("statusBadge"),b=document.getElementById("modelBadge"),i=document.getElementById("modelInfo");
    if(isReady()){el.className="nav-status ok";el.textContent="‚úÖ IA Conectada";b.textContent=ep().getModel().split("/").pop();i.textContent=CONFIG.provider==="groq"?"Groq API ¬∑ Gratuito":"Qwen API ¬∑ Alibaba";}
    else{el.className="nav-status wait";el.textContent="‚öôÔ∏è Configura API Key";b.textContent="--";i.textContent="Ve a ‚öôÔ∏è Config";}
}
function cambiarProvider(){var v=document.getElementById("cfgProvider").value;document.getElementById("groqConfig").style.display=v==="groq"?"block":"none";document.getElementById("qwenConfig").style.display=v==="qwen"?"block":"none";}

// ‚ïê‚ïê‚ïê CORS PROXY WRAPPER ‚ïê‚ïê‚ïê
// GitHub Pages ‚Üí API calls get blocked by CORS
// We try direct first, then fall back to proxy
async function fetchWithCorsProxy(url, options) {
    // Try direct first
    try {
        var r = await fetch(url, options);
        return r;
    } catch(directErr) {
        console.log("Direct fetch failed, trying proxy...", directErr.message);
    }

    // Proxy approach: use a Cloudflare Worker-style proxy
    // We build the request through corsproxy.io
    var proxies = [
        "https://corsproxy.io/?url=",
        "https://api.allorigins.win/raw?url="
    ];

    for (var i = 0; i < proxies.length; i++) {
        try {
            var proxyUrl = proxies[i] + encodeURIComponent(url);
            var r = await fetch(proxyUrl, options);
            return r;
        } catch(proxyErr) {
            console.log("Proxy " + i + " failed:", proxyErr.message);
        }
    }

    throw new Error("No se pudo conectar. Verifica tu conexi√≥n a internet.");
}

async function llamarIA(userPrompt,systemPrompt){
    if(!isReady())return"‚ö†Ô∏è Configura tu API Key en la pesta√±a ‚öôÔ∏è Config";
    var e=ep();
    try{
        var r=await fetchWithCorsProxy(e.url,{
            method:"POST",
            headers:{"Content-Type":"application/json","Authorization":"Bearer "+e.getKey()},
            body:JSON.stringify({model:e.getModel(),messages:[{role:"system",content:systemPrompt||"Eres un asistente m√©dico. Responde en espa√±ol."},{role:"user",content:userPrompt}],temperature:0.7,max_tokens:2048})
        });
        if(!r.ok){
            var errText = "";
            try { var errData = await r.json(); errText = errData.error && errData.error.message ? errData.error.message : ""; } catch(x){}
            if(r.status===401)return"‚ùå API Key inv√°lida. Revisa tu key en ‚öôÔ∏è Config.";
            if(r.status===429)return"‚è≥ L√≠mite alcanzado. Espera un momento.";
            return"‚ùå Error "+r.status+(errText?": "+errText:"");
        }
        var data=await r.json();
        var content=(data.choices&&data.choices[0]&&data.choices[0].message)?data.choices[0].message.content:"Sin respuesta";
        content=content.replace(/<think>[\s\S]*?<\/think>/g,"").trim();
        return content||"Sin respuesta";
    }catch(e){return"‚ùå Error: "+e.message}
}

async function hacerPregunta(){
    var input=document.getElementById("preguntaInput"),q=input.value.trim();if(!q||isProcessing)return;
    if(!isReady()){switchTab("config",document.querySelectorAll(".tab-btn")[4]);alert("‚öôÔ∏è Configura tu API Key primero");return;}
    isProcessing=true;document.getElementById("btnPreguntar").disabled=true;
    if(!preguntas[currentCategory])preguntas[currentCategory]=[];
    var idx=preguntas[currentCategory].length;
    preguntas[currentCategory].push({pregunta:q,respuesta:"‚è≥ Consultando "+ep().getModel().split("/").pop()+"...",fecha:new Date().toLocaleString("es-ES")});
    input.value="";actualizarUI();
    var docs=documents[currentCategory]||[];var docsCtx=docs.map(function(d){return"- "+d.name}).join("\n");
    var sys="Eres un asistente m√©dico especializado en "+currentCategory+". Responde de forma clara, precisa y basada en evidencia m√©dica. Responde siempre en espa√±ol."+(docsCtx?"\n\nDocumentos disponibles:\n"+docsCtx:"");
    var resp=await llamarIA(q,sys);preguntas[currentCategory][idx].respuesta=resp;
    guardarDatos();actualizarUI();isProcessing=false;document.getElementById("btnPreguntar").disabled=false;
}

var studioPrompts={resumen:{title:"üìã Resumen ‚Äî ",prompt:"Genera un resumen ejecutivo completo sobre {cat}. Incluye: patolog√≠as frecuentes, m√©todos diagn√≥sticos, tratamientos est√°ndar."},faq:{title:"‚ùì FAQ ‚Äî ",prompt:"Genera 8 preguntas frecuentes sobre {cat} con respuestas detalladas."},guia:{title:"üìñ Gu√≠a ‚Äî ",prompt:"Crea una gu√≠a de estudio sobre {cat}: conceptos, clasificaciones, criterios diagn√≥sticos, f√°rmacos clave con dosis, preguntas de repaso."},diagnostico:{title:"ü©∫ Dx ‚Äî ",prompt:"Diagn√≥stico diferencial de patolog√≠as comunes en {cat}. S√≠ntomas, pruebas, diferenciales, red flags."},farmacologia:{title:"üíä Farma ‚Äî ",prompt:"Resumen farmacol√≥gico de {cat}: grupos, mecanismo, indicaciones, dosis, efectos adversos, contraindicaciones."},emergencia:{title:"üö® Urgencia ‚Äî ",prompt:"Protocolos de emergencia en {cat}: reconocimiento, medidas inmediatas, tratamiento urgente con dosis, criterios derivaci√≥n."}};
var lastStudioContent="",lastStudioTitle="";

async function studioAction(tipo){
    if(!isReady()||isProcessing){if(!isReady()){switchTab("config",document.querySelectorAll(".tab-btn")[4]);alert("‚öôÔ∏è Configura API Key primero");}return;}
    var cfg=studioPrompts[tipo];if(!cfg)return;isProcessing=true;document.querySelectorAll(".studio-card").forEach(function(c){c.disabled=true});
    var rd=document.getElementById("studioResult"),cd=document.getElementById("studioResultContent");
    lastStudioTitle=cfg.title+currentCategory;document.getElementById("studioResultTitle").textContent=lastStudioTitle;cd.textContent="‚è≥ Generando...";rd.style.display="block";
    lastStudioContent=await llamarIA(cfg.prompt.replace(/\{cat\}/g,currentCategory),"Eres un experto m√©dico. Responde en espa√±ol con precisi√≥n.");
    cd.textContent=lastStudioContent;isProcessing=false;document.querySelectorAll(".studio-card").forEach(function(c){c.disabled=false});
}
function guardarStudioComoNota(){if(!lastStudioContent)return;if(!notas[currentCategory])notas[currentCategory]=[];notas[currentCategory].push({texto:lastStudioTitle+"\n\n"+lastStudioContent,fecha:new Date().toLocaleString("es-ES")});guardarDatos();actualizarUI();alert("‚úÖ Guardado como nota")}
function agregarNota(){var t=document.getElementById("noteInput").value.trim();if(!t)return;if(!notas[currentCategory])notas[currentCategory]=[];notas[currentCategory].push({texto:t,fecha:new Date().toLocaleString("es-ES")});document.getElementById("noteInput").value="";guardarDatos();actualizarUI();}
function eliminarNota(i){if(!confirm("¬øEliminar?"))return;notas[currentCategory].splice(i,1);guardarDatos();actualizarUI();}
function switchTab(n,b){document.querySelectorAll(".tab-content").forEach(function(t){t.classList.remove("active")});document.querySelectorAll(".tab-btn").forEach(function(x){x.classList.remove("active")});document.getElementById(n).classList.add("active");if(b)b.classList.add("active");}
function cambiarCategoria(c,b){currentCategory=c;document.querySelectorAll(".category-btn").forEach(function(x){x.classList.remove("active")});if(b)b.classList.add("active");document.getElementById("categoryTitle").textContent=c;var sc=document.getElementById("studioCategory");if(sc)sc.textContent=c;switchTab("preguntas",document.querySelector(".tab-btn"));actualizarUI();}
function esc(t){if(!t)return"";return t.replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;")}
function actualizarUI(){
    var docs=documents[currentCategory]||[];
    document.getElementById("documentosList").innerHTML=docs.length===0?'<div class="empty-state"><div class="empty-state-icon">üìÑ</div><p>No hay documentos en esta categor√≠a</p></div>':docs.map(function(d){return'<div class="doc-item"><div class="doc-info"><div class="doc-name">'+d.name+'</div><div class="doc-size">'+d.size_mb+' MB ¬∑ '+d.type+'</div></div><a href="'+d.url+'" target="_blank" class="doc-btn">Abrir</a></div>'}).join("");
    document.getElementById("docsCount").textContent=docs.length;document.getElementById("preguntasCount").textContent=(preguntas[currentCategory]||[]).length;document.getElementById("notasCount").textContent=(notas[currentCategory]||[]).length;
    var pa=preguntas[currentCategory]||[],pl=document.getElementById("preguntasList");
    pl.innerHTML=pa.length===0?'<div class="empty-state"><div class="empty-state-icon">ü©∫</div><p>Haz tu primera pregunta cl√≠nica</p></div>':pa.map(function(p){return'<div class="question-box"><div class="question-text">'+esc(p.pregunta)+'</div><div class="answer-text">'+esc(p.respuesta)+'</div><div class="note-time">'+p.fecha+'</div></div>'}).join("");
    var na=notas[currentCategory]||[],nl=document.getElementById("notasList");
    nl.innerHTML=na.length===0?'<div class="empty-state"><div class="empty-state-icon">üìù</div><p>Sin notas cl√≠nicas</p></div>':na.map(function(n,i){return'<div class="question-box" style="border-left-color:var(--accent)"><div style="color:var(--text);font-size:.92rem;white-space:pre-wrap;padding-right:30px;font-weight:300;line-height:1.6">'+esc(n.texto)+'</div><div class="note-time">'+n.fecha+'</div><button onclick="eliminarNota('+i+')" style="position:absolute;top:12px;right:12px;background:none;border:none;cursor:pointer;font-size:.85rem;opacity:.35">üóëÔ∏è</button></div>'}).join("");
}
function guardarConfig(){CONFIG.provider=document.getElementById("cfgProvider").value;CONFIG.groqKey=document.getElementById("cfgGroqKey").value.trim();CONFIG.groqModel=document.getElementById("cfgGroqModel").value;CONFIG.qwenKey=document.getElementById("cfgQwenKey").value.trim();CONFIG.qwenModel=document.getElementById("cfgQwenModel").value;localStorage.setItem("notebook_ai_cfg_v3",JSON.stringify(CONFIG));updateStatus();document.getElementById("cfgStatus").innerHTML='<span style="color:var(--primary)">‚úÖ Configuraci√≥n guardada</span>';}
async function testApiKey(){guardarConfig();if(!isReady()){document.getElementById("cfgStatus").innerHTML='<span style="color:#dc2626">‚ùå Introduce una API Key v√°lida</span>';return;}var st=document.getElementById("cfgStatus");st.innerHTML='<span style="color:var(--accent)">‚è≥ Probando conexi√≥n...</span>';var e=ep();try{var r=await fetchWithCorsProxy(e.url,{method:"POST",headers:{"Content-Type":"application/json","Authorization":"Bearer "+e.getKey()},body:JSON.stringify({model:e.getModel(),messages:[{role:"user",content:"Di solo: OK"}],max_tokens:10})});if(r.ok)st.innerHTML='<span style="color:var(--primary)">‚úÖ ¬°Conexi√≥n exitosa! Todo funciona.</span>';else if(r.status===401)st.innerHTML='<span style="color:#dc2626">‚ùå API Key inv√°lida</span>';else{var err=await r.json().catch(function(){return{}});st.innerHTML='<span style="color:#dc2626">‚ùå Error '+r.status+": "+(err.error&&err.error.message?err.error.message:"")+"</span>";}}catch(err){st.innerHTML='<span style="color:#dc2626">‚ùå Error: '+err.message+"</span>";}}
function guardarDatos(){localStorage.setItem("cartagena_preguntas",JSON.stringify(preguntas));localStorage.setItem("cartagena_notas",JSON.stringify(notas));}
function cargarDatos(){try{preguntas=JSON.parse(localStorage.getItem("cartagena_preguntas"))||{};}catch(e){preguntas={};}try{notas=JSON.parse(localStorage.getItem("cartagena_notas"))||{};}catch(e){notas={};}}
function init(){
    var p=new URLSearchParams(window.location.search),c=p.get("category");if(c&&categories[c])currentCategory=c;
    var list=document.getElementById("categoriesList");
    Object.keys(categories).forEach(function(cat){var btn=document.createElement("button");btn.className="category-btn"+(cat===currentCategory?" active":"");btn.innerHTML='<span class="cat-emoji">'+categories[cat]+'</span>'+cat;btn.onclick=function(){cambiarCategoria(cat,btn)};list.appendChild(btn);});
    document.getElementById("categoryTitle").textContent=currentCategory;
    document.getElementById("cfgProvider").value=CONFIG.provider;cambiarProvider();
    document.getElementById("cfgGroqKey").value=CONFIG.groqKey||"";document.getElementById("cfgGroqModel").value=CONFIG.groqModel;
    document.getElementById("cfgQwenKey").value=CONFIG.qwenKey||"";document.getElementById("cfgQwenModel").value=CONFIG.qwenModel;
    cargarDatos();updateStatus();actualizarUI();
    fetch("documents.json").then(function(r){return r.json()}).then(function(d){documents=d.categories;actualizarUI();}).catch(function(){});
    document.getElementById("preguntaInput").addEventListener("keypress",function(e){if(e.key==="Enter")hacerPregunta()});
    if(!isReady())setTimeout(function(){switchTab("config",document.querySelectorAll(".tab-btn")[4])},500);
}
document.addEventListener("DOMContentLoaded",init);
</script>
</body>
</html>
